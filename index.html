<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RapidSend - Entregas Express</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --dark: #1a1a2e;
            --light: #f8f9fa;
            --gray: #6c757d;
            --card-shadow: 0 2px 15px rgba(0,0,0,0.08);
            --border-radius: 12px;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            min-height: 100vh;
        }
        
        .card-main {
            background: white;
            border: none;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
        }
        
        .btn-primary {
            background: var(--primary);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .connection-badge {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 10000;
        }
        
        .connection-online {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .connection-offline {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .stat-card {
            text-align: center;
            padding: 1.5rem;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            line-height: 1;
            margin-bottom: 0.5rem;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-pending { background: #fff3cd; color: #856404; }
        .status-accepted { background: #d1ecf1; color: #0c5460; }
        .status-delivered { background: #d1f2eb; color: #0e6251; }
    </style>
    
    <!-- Firebase SDK v9+ (Modular) -->
    <script type="module">
        // Import Firebase v9+ (m√°s liviano y moderno)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc, 
            query, 
            where, 
            orderBy, 
            serverTimestamp,
            onSnapshot 
        } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        // üî• TUS NUEVAS CREDENCIALES (SEGURAS)
        const firebaseConfig = {
            apiKey: "AIzaSyDxD4g_uYEUKB37uNHvDWus_NQHoSAMK_8",
            authDomain: "rapidsend-1f640.firebaseapp.com",
            projectId: "rapidsend-1f640",
            storageBucket: "rapidsend-1f640.firebasestorage.app",
            messagingSenderId: "249514582496",
            appId: "1:249514582496:web:cafcc8760282983f24cb85"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Exportar para uso global
        window.firebaseAuth = auth;
        window.firebaseDB = db;
        window.firebaseApp = app;
        
        // Funciones disponibles globalmente
        window.firebase = {
            auth: {
                createUser: createUserWithEmailAndPassword,
                signIn: signInWithEmailAndPassword,
                signOut: signOut,
                onAuthStateChanged: onAuthStateChanged
            },
            firestore: {
                collection,
                addDoc,
                getDocs,
                doc,
                getDoc,
                setDoc,
                updateDoc,
                query,
                where,
                orderBy,
                serverTimestamp,
                onSnapshot
            }
        };

        console.log('‚úÖ Firebase v10.7.0 inicializado');
        console.log('üìÅ Proyecto:', firebaseConfig.projectId);
        
        // Prueba de conexi√≥n inicial
        async function testConnection() {
            try {
                await addDoc(collection(db, 'connection_test'), {
                    test: 'Conexi√≥n establecida',
                    timestamp: serverTimestamp(),
                    project: firebaseConfig.projectId
                });
                console.log('‚úÖ Conexi√≥n a Firestore exitosa');
                updateConnectionStatus(true);
                return true;
            } catch (error) {
                console.warn('‚ö†Ô∏è Firestore puede necesitar configuraci√≥n:', error.message);
                // Esto es normal si las reglas de seguridad est√°n activas
                updateConnectionStatus(true); // Asumir conexi√≥n para Auth
                return false;
            }
        }
        
        function updateConnectionStatus(connected) {
            let badge = document.getElementById('connectionBadge');
            if (!badge) {
                badge = document.createElement('div');
                badge.id = 'connectionBadge';
                badge.className = 'connection-badge';
                document.body.appendChild(badge);
            }
            
            if (connected) {
                badge.innerHTML = '<i class="fas fa-wifi"></i> Conectado';
                badge.className = 'connection-badge connection-online';
            } else {
                badge.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Sin conexi√≥n';
                badge.className = 'connection-badge connection-offline';
            }
        }
        
        // Ejecutar prueba de conexi√≥n
        setTimeout(testConnection, 1000);
    </script>
</head>
<body>
    <div id="app">
        <div class="min-vh-100 d-flex align-items-center justify-content-center p-3">
            <div class="card-main" style="width: 100%; max-width: 500px;">
                <div class="card-body p-4 text-center">
                    <div class="mb-4">
                        <div class="rounded-circle bg-primary d-inline-flex align-items-center justify-content-center mb-3" 
                             style="width: 80px; height: 80px;">
                            <i class="fas fa-bolt fa-2x text-white"></i>
                        </div>
                        <h2 class="fw-bold mb-2">RapidSend</h2>
                        <p class="text-muted">Entregas Express en Panam√°</p>
                        <small class="text-success">Firebase v10.7.0 | Credenciales seguras ‚úÖ</small>
                    </div>
                    
                    <div class="loading-spinner"></div>
                    
                    <div class="mt-4" id="initStatus">
                        <p><i class="fas fa-spinner fa-spin text-primary"></i> Inicializando aplicaci√≥n...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap & SweetAlert -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        // ============================================
        // ESTADO Y CONFIGURACI√ìN
        // ============================================
        const AppState = {
            currentUser: null,
            userData: null,
            userRole: null,
            firebaseReady: false
        };

        // ============================================
        // INICIALIZACI√ìN PRINCIPAL
        // ============================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Iniciando RapidSend v2.0...');
            
            // Esperar a que Firebase est√© listo
            await waitForFirebase();
            
            // Configurar listener de autenticaci√≥n
            setupAuth();
        });

        async function waitForFirebase() {
            return new Promise((resolve) => {
                const check = () => {
                    if (window.firebase && window.firebaseAuth && window.firebaseDB) {
                        AppState.firebaseReady = true;
                        console.log('‚úÖ M√≥dulos de Firebase cargados');
                        document.getElementById('initStatus').innerHTML = 
                            '<p><i class="fas fa-check text-success"></i> Firebase listo</p>' +
                            '<p><i class="fas fa-spinner fa-spin text-primary"></i> Verificando usuario...</p>';
                        resolve();
                    } else {
                        setTimeout(check, 100);
                    }
                };
                check();
            });
        }

        function setupAuth() {
            window.firebase.auth.onAuthStateChanged(window.firebaseAuth, async (user) => {
                AppState.currentUser = user;
                
                if (user) {
                    console.log('üë§ Usuario autenticado:', user.email);
                    await loadUserData(user.uid);
                    renderDashboard();
                } else {
                    console.log('üë§ No autenticado - Mostrando login');
                    renderLogin();
                }
            });
        }

        async function loadUserData(uid) {
            try {
                const userDoc = await window.firebase.firestore.getDoc(
                    window.firebase.firestore.doc(window.firebaseDB, 'usuarios', uid)
                );
                
                if (userDoc.exists()) {
                    AppState.userData = userDoc.data();
                    AppState.userRole = AppState.userData.rol;
                    
                    // Guardar en localStorage para persistencia
                    localStorage.setItem('rapidsend_user', JSON.stringify({
                        uid: uid,
                        role: AppState.userRole,
                        data: AppState.userData
                    }));
                    
                    console.log('üìä Datos de usuario cargados:', AppState.userData);
                } else {
                    // Crear documento de usuario si no existe
                    await createUserDocument(uid);
                }
            } catch (error) {
                console.error('Error cargando usuario:', error);
            }
        }

        async function createUserDocument(uid) {
            const user = window.firebaseAuth.currentUser;
            const userData = {
                nombre: user.displayName || 'Usuario',
                email: user.email,
                rol: 'cliente',
                telefono: '',
                fechaRegistro: window.firebase.firestore.serverTimestamp(),
                activo: null
            };
            
            await window.firebase.firestore.setDoc(
                window.firebase.firestore.doc(window.firebaseDB, 'usuarios', uid),
                userData
            );
            
            AppState.userData = userData;
            AppState.userRole = 'cliente';
        }

        // ============================================
        // SISTEMA DE AUTENTICACI√ìN
        // ============================================
        function renderLogin() {
            document.getElementById('app').innerHTML = `
                <div class="min-vh-100 d-flex align-items-center justify-content-center p-3">
                    <div class="card-main" style="width: 100%; max-width: 400px;">
                        <div class="card-body p-4">
                            <div class="text-center mb-4">
                                <div class="rounded-circle bg-primary d-inline-flex align-items-center justify-content-center mb-3" 
                                     style="width: 80px; height: 80px;">
                                    <i class="fas fa-bolt fa-2x text-white"></i>
                                </div>
                                <h2 class="fw-bold mb-2">RapidSend</h2>
                                <p class="text-muted">Entregas Express</p>
                                <div class="badge bg-success">Nuevas Credenciales ‚úÖ</div>
                            </div>

                            <div class="mb-4">
                                <div class="form-floating mb-3">
                                    <input type="email" class="form-control" id="loginEmail" placeholder="Correo">
                                    <label for="loginEmail">Correo electr√≥nico</label>
                                </div>
                                
                                <div class="form-floating mb-3">
                                    <input type="password" class="form-control" id="loginPassword" placeholder="Contrase√±a">
                                    <label for="loginPassword">Contrase√±a</label>
                                </div>
                            </div>
                            
                            <button onclick="loginWithEmail()" class="btn btn-primary w-100 mb-3">
                                <i class="fas fa-sign-in-alt me-2"></i>Iniciar Sesi√≥n
                            </button>
                            
                            <hr class="my-4">
                            
                            <div class="text-center">
                                <p class="text-muted mb-3">¬øNo tienes cuenta?</p>
                                <button onclick="showRegister()" class="btn btn-outline-primary w-100 mb-3">
                                    <i class="fas fa-user-plus me-2"></i>Registrarse
                                </button>
                                
                                <button onclick="quickDemo()" class="btn btn-outline-secondary w-100">
                                    <i class="fas fa-rocket me-2"></i>Demo R√°pida
                                </button>
                            </div>
                            
                            <div class="text-center mt-4">
                                <small class="text-muted">Proyecto: ${firebaseConfig.projectId}</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function showRegister() {
            document.getElementById('app').innerHTML = `
                <div class="min-vh-100 d-flex align-items-center justify-content-center p-3">
                    <div class="card-main" style="width: 100%; max-width: 400px;">
                        <div class="card-body p-4">
                            <div class="text-center mb-4">
                                <h3 class="fw-bold mb-2">Crear Cuenta</h3>
                                <p class="text-muted">Completa tus datos</p>
                            </div>

                            <div class="mb-3">
                                <input type="text" class="form-control" id="regName" placeholder="Nombre completo">
                            </div>
                            
                            <div class="mb-3">
                                <input type="email" class="form-control" id="regEmail" placeholder="Correo electr√≥nico">
                            </div>
                            
                            <div class="mb-3">
                                <input type="password" class="form-control" id="regPassword" placeholder="Contrase√±a (m√≠nimo 6 caracteres)">
                            </div>
                            
                            <div class="mb-3">
                                <div class="input-group">
                                    <span class="input-group-text">+507</span>
                                    <input type="tel" class="form-control" id="regPhone" placeholder="WhatsApp">
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <select class="form-select" id="regRole">
                                    <option value="cliente">üë§ Soy Cliente</option>
                                    <option value="repartidor">üèçÔ∏è Soy Repartidor</option>
                                </select>
                            </div>
                            
                            <button onclick="registerWithEmail()" class="btn btn-primary w-100 mb-3">
                                <i class="fas fa-user-plus me-2"></i>Crear Cuenta
                            </button>
                            
                            <button onclick="renderLogin()" class="btn btn-outline-secondary w-100">
                                <i class="fas fa-arrow-left me-2"></i>Volver al Login
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loginWithEmail() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                Swal.fire('Error', 'Completa todos los campos', 'error');
                return;
            }
            
            try {
                await window.firebase.auth.signIn(
                    window.firebaseAuth, 
                    email, 
                    password
                );
                // El listener onAuthStateChanged manejar√° el redireccionamiento
            } catch (error) {
                console.error('Login error:', error);
                Swal.fire('Error', error.message, 'error');
            }
        }

        async function registerWithEmail() {
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const phone = document.getElementById('regPhone').value;
            const role = document.getElementById('regRole').value;
            
            if (!name || !email || !password || !phone) {
                Swal.fire('Error', 'Completa todos los campos', 'error');
                return;
            }
            
            if (password.length < 6) {
                Swal.fire('Error', 'La contrase√±a debe tener al menos 6 caracteres', 'error');
                return;
            }
            
            try {
                // Crear usuario en Auth
                const result = await window.firebase.auth.createUser(
                    window.firebaseAuth,
                    email,
                    password
                );
                
                // Actualizar perfil
                await result.user.updateProfile({ displayName: name });
                
                // Crear documento en Firestore
                await window.firebase.firestore.setDoc(
                    window.firebase.firestore.doc(window.firebaseDB, 'usuarios', result.user.uid),
                    {
                        nombre: name,
                        email: email,
                        rol: role,
                        telefono: `+507${phone.replace(/\D/g, '')}`,
                        fechaRegistro: window.firebase.firestore.serverTimestamp(),
                        activo: role === 'repartidor' ? true : null
                    }
                );
                
                Swal.fire('‚úÖ Cuenta creada', 'Bienvenido a RapidSend', 'success');
                // El listener onAuthStateChanged manejar√° el redireccionamiento
                
            } catch (error) {
                console.error('Register error:', error);
                Swal.fire('Error', error.message, 'error');
            }
        }

        async function quickDemo() {
            try {
                // Intentar login con usuario demo
                await window.firebase.auth.signIn(
                    window.firebaseAuth,
                    'demo@rapidsend.com',
                    'demo123456'
                );
            } catch (error) {
                if (error.code === 'auth/user-not-found') {
                    // Crear usuario demo
                    await createDemoUser();
                } else {
                    Swal.fire('Error', error.message, 'error');
                }
            }
        }

        async function createDemoUser() {
            try {
                const result = await window.firebase.auth.createUser(
                    window.firebaseAuth,
                    'demo@rapidsend.com',
                    'demo123456'
                );
                
                await result.user.updateProfile({ displayName: 'Usuario Demo' });
                
                await window.firebase.firestore.setDoc(
                    window.firebase.firestore.doc(window.firebaseDB, 'usuarios', result.user.uid),
                    {
                        nombre: 'Usuario Demo',
                        email: 'demo@rapidsend.com',
                        rol: 'cliente',
                        telefono: '+50760000000',
                        fechaRegistro: window.firebase.firestore.serverTimestamp(),
                        activo: null
                    }
                );
                
                Swal.fire('‚úÖ Demo creado', 'Ahora puedes explorar RapidSend', 'success');
                
            } catch (error) {
                Swal.fire('Error', 'No se pudo crear el demo', 'error');
            }
        }

        // ============================================
        // DASHBOARD PRINCIPAL
        // ============================================
        function renderDashboard() {
            document.getElementById('app').innerHTML = `
                <!-- Navbar -->
                <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
                    <div class="container-fluid">
                        <a class="navbar-brand fw-bold text-primary" href="#">
                            <i class="fas fa-bolt me-2"></i>RapidSend
                        </a>
                        
                        <div class="d-flex align-items-center">
                            <span class="badge bg-primary me-3">${AppState.userRole === 'cliente' ? 'Cliente' : 'Repartidor'}</span>
                            
                            <div class="dropdown">
                                <button class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                                    <i class="fas fa-user me-2"></i>${AppState.userData?.nombre || 'Usuario'}
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="showProfile()"><i class="fas fa-id-card me-2"></i>Mi Perfil</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesi√≥n</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </nav>

                <!-- Contenido Principal -->
                <div class="container-fluid py-4">
                    <!-- Bienvenida -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card-main">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h3 class="fw-bold mb-3">¬°Bienvenido, ${AppState.userData?.nombre?.split(' ')[0] || 'Usuario'}! üëã</h3>
                                            <p class="text-muted mb-4">Tu aplicaci√≥n de entregas express est√° lista.</p>
                                            
                                            <div class="d-flex flex-wrap gap-3">
                                                <button class="btn btn-primary" onclick="createTestOrder()">
                                                    <i class="fas fa-plus me-2"></i>Crear Pedido Test
                                                </button>
                                                <button class="btn btn-outline-primary" onclick="checkCollections()">
                                                    <i class="fas fa-database me-2"></i>Ver Base de Datos
                                                </button>
                                                <button class="btn btn-outline-success" onclick="testAllServices()">
                                                    <i class="fas fa-vial me-2"></i>Probar Servicios
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-md-4 text-center">
                                            <div class="rounded-circle ${AppState.userRole === 'cliente' ? 'bg-primary' : 'bg-warning'} d-inline-flex align-items-center justify-content-center" 
                                                 style="width: 120px; height: 120px;">
                                                <i class="fas ${AppState.userRole === 'cliente' ? 'fa-user' : 'fa-motorcycle'} fa-3x text-white"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Estad√≠sticas -->
                    <div class="row mb-4">
                        <div class="col-md-3 col-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-number text-success">‚úÖ</div>
                                <div class="stat-label">Firebase</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-number">${AppState.userRole === 'cliente' ? 'üë§' : 'üèçÔ∏è'}</div>
                                <div class="stat-label">${AppState.userRole === 'cliente' ? 'Cliente' : 'Repartidor'}</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-number text-primary" id="ordersCount">0</div>
                                <div class="stat-label">Pedidos</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-number text-info" id="usersCount">0</div>
                                <div class="stat-label">Usuarios</div>
                            </div>
                        </div>
                    </div>

                    <!-- Funciones Principales -->
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card-main h-100">
                                <div class="card-body">
                                    <h5 class="fw-bold mb-3"><i class="fas fa-cogs me-2"></i>Configuraci√≥n</h5>
                                    <div class="list-group list-group-flush">
                                        <button class="list-group-item list-group-item-action" onclick="showProfile()">
                                            <i class="fas fa-user-cog me-2"></i>Editar Perfil
                                        </button>
                                        <button class="list-group-item list-group-item-action" onclick="checkDatabase()">
                                            <i class="fas fa-database me-2"></i>Estado de la Base de Datos
                                        </button>
                                        <button class="list-group-item list-group-item-action" onclick="showFirebaseConfig()">
                                            <i class="fas fa-fire me-2"></i>Ver Configuraci√≥n Firebase
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-4">
                            <div class="card-main h-100">
                                <div class="card-body">
                                    <h5 class="fw-bold mb-3"><i class="fas fa-rocket me-2"></i>Acciones R√°pidas</h5>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-primary" onclick="createOrderModal()">
                                            <i class="fas fa-shipping-fast me-2"></i>Nuevo Pedido
                                        </button>
                                        ${AppState.userRole === 'repartidor' ? `
                                            <button class="btn btn-success" onclick="loadAvailableOrders()">
                                                <i class="fas fa-search me-2"></i>Buscar Pedidos
                                            </button>
                                        ` : ''}
                                        <button class="btn btn-outline-primary" onclick="viewOrders()">
                                            <i class="fas fa-list me-2"></i>Ver Mis Pedidos
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Cargar estad√≠sticas
            loadDashboardStats();
        }

        async function loadDashboardStats() {
            try {
                // Contar usuarios
                const usersSnapshot = await window.firebase.firestore.getDocs(
                    window.firebase.firestore.collection(window.firebaseDB, 'usuarios')
                );
                document.getElementById('usersCount').textContent = usersSnapshot.size;
                
                // Contar pedidos del usuario actual
                const ordersQuery = window.firebase.firestore.query(
                    window.firebase.firestore.collection(window.firebaseDB, 'pedidos'),
                    window.firebase.firestore.where('clienteId', '==', AppState.currentUser.uid)
                );
                const ordersSnapshot = await window.firebase.firestore.getDocs(ordersQuery);
                document.getElementById('ordersCount').textContent = ordersSnapshot.size;
                
            } catch (error) {
                console.error('Error cargando estad√≠sticas:', error);
            }
        }

        // ============================================
        // FUNCIONES PRINCIPALES
        // ============================================
        async function createTestOrder() {
            try {
                const orderData = {
                    clienteId: AppState.currentUser.uid,
                    clienteNombre: AppState.userData?.nombre || 'Cliente',
                    clienteTelefono: AppState.userData?.telefono || '+50700000000',
                    descripcion: 'Pedido de prueba - Documentos importantes',
                    origen: 'Calle 50, Panam√°',
                    destino: 'V√≠a Espa√±a, Panam√°',
                    urgencia: 'standard',
                    precio: 15.50,
                    metodoPago: 'cash',
                    status: 'pending',
                    createdAt: window.firebase.firestore.serverTimestamp(),
                    updatedAt: window.firebase.firestore.serverTimestamp()
                };
                
                await window.firebase.firestore.addDoc(
                    window.firebase.firestore.collection(window.firebaseDB, 'pedidos'),
                    orderData
                );
                
                Swal.fire({
                    title: '‚úÖ Pedido creado',
                    text: 'Se ha agregado un pedido de prueba a la base de datos',
                    icon: 'success'
                }).then(() => {
                    loadDashboardStats();
                });
                
            } catch (error) {
                Swal.fire('Error', `No se pudo crear: ${error.message}`, 'error');
            }
        }

        async function checkCollections() {
            const collections = ['usuarios', 'pedidos', 'notificaciones', 'chats'];
            let results = [];
            
            for (const coll of collections) {
                try {
                    const snapshot = await window.firebase.firestore.getDocs(
                        window.firebase.firestore.collection(window.firebaseDB, coll)
                    );
                    results.push(`‚úÖ ${coll}: ${snapshot.size} documentos`);
                } catch (error) {
                    results.push(`‚ùå ${coll}: No existe o sin permisos`);
                }
            }
            
            Swal.fire({
                title: 'üìÅ Estado de Colecciones',
                html: `<div class="text-start"><pre>${results.join('\n')}</pre></div>`,
                width: 500
            });
        }

        async function testAllServices() {
            const tests = [
                { name: 'Auth - Usuario actual', test: () => AppState.currentUser ? '‚úÖ' : '‚ùå' },
                { name: 'Firestore - Conexi√≥n', test: testFirestoreConnection },
                { name: 'Firestore - Escritura', test: testFirestoreWrite },
                { name: 'LocalStorage', test: () => localStorage.getItem('rapidsend_user') ? '‚úÖ' : '‚ö†Ô∏è' }
            ];
            
            let results = [];
            
            for (const test of tests) {
                try {
                    const result = await (typeof test.test === 'function' ? test.test() : test.test);
                    results.push(`${result} ${test.name}`);
                } catch (error) {
                    results.push(`‚ùå ${test.name}: ${error.message}`);
                }
            }
            
            Swal.fire({
                title: 'üß™ Resultados de Prueba',
                html: `<div class="text-start"><pre>${results.join('\n')}</pre></div>`,
                icon: 'info'
            });
        }

        async function testFirestoreConnection() {
            try {
                const testDoc = await window.firebase.firestore.addDoc(
                    window.firebase.firestore.collection(window.firebaseDB, 'test_logs'),
                    {
                        test: 'Prueba de conexi√≥n',
                        timestamp: window.firebase.firestore.serverTimestamp(),
                        userId: AppState.currentUser.uid
                    }
                );
                return '‚úÖ';
            } catch (error) {
                throw new Error(error.message);
            }
        }

        async function testFirestoreWrite() {
            try {
                await window.firebase.firestore.setDoc(
                    window.firebase.firestore.doc(window.firebaseDB, 'test', 'connection'),
                    {
                        lastTest: new Date().toISOString(),
                        status: 'active',
                        user: AppState.currentUser.email
                    }
                );
                return '‚úÖ';
            } catch (error) {
                throw new Error(error.message);
            }
        }

        function showProfile() {
            Swal.fire({
                title: 'Mi Perfil',
                html: `
                    <div class="text-center">
                        <div class="profile-pic mx-auto mb-3" style="background: #4361ee; color: white; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-user fa-3x"></i>
                        </div>
                        
                        <h5>${AppState.userData?.nombre || 'Usuario'}</h5>
                        <p class="text-muted">${AppState.userData?.email || ''}</p>
                        
                        <div class="text-start mt-4">
                            <p><strong>Rol:</strong> ${AppState.userRole === 'cliente' ? 'Cliente' : 'Repartidor'}</p>
                            <p><strong>Tel√©fono:</strong> ${AppState.userData?.telefono || 'No registrado'}</p>
                            <p><strong>ID Firebase:</strong> <small>${AppState.currentUser?.uid?.substring(0, 15)}...</small></p>
                        </div>
                    </div>
                `,
                showConfirmButton: false,
                showCloseButton: true
            });
        }

        function showFirebaseConfig() {
            Swal.fire({
                title: 'Configuraci√≥n Firebase',
                html: `
                    <div class="text-start">
                        <pre style="font-size: 12px; background: #f8f9fa; padding: 10px; border-radius: 5px;">
${JSON.stringify(firebaseConfig, null, 2)}
                        </pre>
                        <p class="small text-muted mt-3">Estado: <span class="text-success">‚úÖ Configurado correctamente</span></p>
                    </div>
                `,
                width: 600
            });
        }

        function createOrderModal() {
            Swal.fire({
                title: 'Crear Nuevo Pedido',
                html: `
                    <div class="text-start">
                        <div class="mb-3">
                            <label class="form-label">Descripci√≥n</label>
                            <input type="text" class="form-control" id="orderDesc" placeholder="¬øQu√© vas a enviar?">
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Origen</label>
                                <input type="text" class="form-control" id="orderFrom" placeholder="Desde">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Destino</label>
                                <input type="text" class="form-control" id="orderTo" placeholder="Hacia">
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Precio ($)</label>
                                <input type="number" class="form-control" id="orderPrice" value="10" min="3" max="100">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Urgencia</label>
                                <select class="form-select" id="orderUrgency">
                                    <option value="standard">Normal</option>
                                    <option value="express">Express</option>
                                    <option value="urgent">Urgente</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Crear Pedido',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    const desc = document.getElementById('orderDesc').value;
                    const from = document.getElementById('orderFrom').value;
                    const to = document.getElementById('orderTo').value;
                    const price = document.getElementById('orderPrice').value;
                    
                    if (!desc || !from || !to) {
                        Swal.showValidationMessage('Completa todos los campos');
                        return false;
                    }
                    
                    return { desc, from, to, price };
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    await createOrder(result.value);
                }
            });
        }

        async function createOrder(data) {
            try {
                const orderData = {
                    clienteId: AppState.currentUser.uid,
                    clienteNombre: AppState.userData?.nombre || 'Cliente',
                    clienteTelefono: AppState.userData?.telefono || '',
                    descripcion: data.desc,
                    origen: data.from,
                    destino: data.to,
                    urgencia: document.getElementById('orderUrgency').value,
                    precio: parseFloat(data.price),
                    metodoPago: 'cash',
                    status: 'pending',
                    createdAt: window.firebase.firestore.serverTimestamp(),
                    updatedAt: window.firebase.firestore.serverTimestamp()
                };
                
                await window.firebase.firestore.addDoc(
                    window.firebase.firestore.collection(window.firebaseDB, 'pedidos'),
                    orderData
                );
                
                Swal.fire('‚úÖ Pedido publicado', 'Los repartidores ser√°n notificados', 'success');
                loadDashboardStats();
                
            } catch (error) {
                Swal.fire('Error', `No se pudo crear: ${error.message}`, 'error');
            }
        }

        async function logout() {
            try {
                await window.firebase.auth.signOut(window.firebaseAuth);
                localStorage.removeItem('rapidsend_user');
                // El listener onAuthStateChanged manejar√° el redireccionamiento
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // ============================================
        // FUNCIONES ADICIONALES
        // ============================================
        function checkDatabase() {
            Swal.fire({
                title: 'Estado de la Base de Datos',
                html: `
                    <div class="text-start">
                        <p><strong>Proyecto Firebase:</strong> ${firebaseConfig.projectId}</p>
                        <p><strong>App ID:</strong> ${firebaseConfig.appId.substring(0, 20)}...</p>
                        <p><strong>API Key:</strong> ${firebaseConfig.apiKey.substring(0, 20)}...</p>
                        <hr>
                        <p>‚úÖ Authentication configurado</p>
                        <p>‚úÖ Firestore Database activo</p>
                        <p>‚úÖ Credenciales seguras</p>
                        <p>‚úÖ Usuario actual: ${AppState.currentUser?.email}</p>
                    </div>
                `,
                icon: 'info'
            });
        }

        function viewOrders() {
            Swal.fire('En desarrollo', 'Esta funci√≥n estar√° disponible en la pr√≥xima actualizaci√≥n', 'info');
        }

        function loadAvailableOrders() {
            Swal.fire('Modo Repartidor', 'Buscando pedidos disponibles...', 'info');
        }

        console.log('‚ú® Aplicaci√≥n RapidSend inicializada');
    </script>
</body>
</html>
