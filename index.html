<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RapidSend - Entregas Express</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <style>
        /* ====== COLORES ORIGINALES DE RAPIDSEND ====== */
        :root {
            --primary: #e74c3c;      /* ROJO PRINCIPAL (tu color original) */
            --primary-dark: #c0392b;  /* Rojo oscuro */
            --secondary: #3498db;     /* Azul para acentos */
            --success: #2ecc71;       /* Verde √©xito */
            --danger: #e74c3c;        /* Rojo peligro (igual que primary) */
            --warning: #f39c12;       /* Naranja advertencia */
            --info: #3498db;          /* Azul info */
            --dark: #2c3e50;          /* Azul oscuro texto */
            --light: #ecf0f1;         /* Gris claro fondo */
            --gray: #95a5a6;          /* Gris texto */
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f9f9f9 0%, #e8e8e8 100%);
            color: #333;
            min-height: 100vh;
        }
        
        /* ====== NAVBAR ROJA ====== */
        .navbar-main {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%) !important;
            box-shadow: 0 2px 15px rgba(231, 76, 60, 0.3);
            padding: 1rem 0;
        }
        
        .navbar-brand {
            font-weight: 800;
            font-size: 1.8rem;
            color: white !important;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
        }
        
        .navbar-brand i {
            color: white;
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        
        /* ====== BOTONES ROJOS ====== */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-weight: 700;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, #a93226 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }
        
        .btn-outline-primary {
            border: 2px solid var(--primary);
            color: var(--primary);
            background: transparent;
            font-weight: 600;
        }
        
        .btn-outline-primary:hover {
            background: var(--primary);
            color: white;
        }
        
        /* ====== TARJETAS CON BORDES ROJOS ====== */
        .card-main {
            background: white;
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            border-top: 5px solid var(--primary);
            transition: all 0.3s ease;
        }
        
        .card-main:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        /* ====== BADGES ROJOS ====== */
        .badge-rapidsend {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 6px 15px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.8rem;
        }
        
        .badge-urgent {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }
        
        .badge-express {
            background: linear-gradient(135deg, #f39c12 0%, #d35400 100%);
            color: white;
        }
        
        .badge-standard {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
        }
        
        /* ====== SPINNER ROJO ====== */
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(231, 76, 60, 0.1);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ====== ESTAD√çSTICAS CON ICONOS ROJOS ====== */
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border: 2px solid rgba(231, 76, 60, 0.1);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
        }
        
        .stat-icon {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        .stat-number {
            font-size: 2.8rem;
            font-weight: 800;
            color: var(--primary);
            line-height: 1;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: var(--gray);
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* ====== FORMULARIOS ====== */
        .form-control {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }
        
        /* ====== T√çTULOS ROJOS ====== */
        .title-red {
            color: var(--primary);
            font-weight: 800;
            position: relative;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        
        .title-red:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 4px;
            background: var(--primary);
            border-radius: 2px;
        }
        
        /* ====== PEDIDOS CON BORDES IZQUIERDOS COLORIDOS ====== */
        .order-card {
            background: white;
            border-left: 5px solid var(--primary);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        
        .order-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .order-card.urgent {
            border-left-color: #e74c3c;
            background: linear-gradient(to right, rgba(231, 76, 60, 0.05), white);
        }
        
        .order-card.express {
            border-left-color: #f39c12;
            background: linear-gradient(to right, rgba(243, 156, 18, 0.05), white);
        }
        
        .order-card.standard {
            border-left-color: #2ecc71;
            background: linear-gradient(to right, rgba(46, 204, 113, 0.05), white);
        }
        
        /* ====== ESTADOS DE PEDIDOS ====== */
        .status-badge {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        .status-pending {
            background: rgba(231, 76, 60, 0.1);
            color: var(--primary);
        }
        
        .status-accepted {
            background: rgba(52, 152, 219, 0.1);
            color: var(--info);
        }
        
        .status-delivered {
            background: rgba(46, 204, 113, 0.1);
            color: var(--success);
        }
        
        /* ====== CONEXI√ìN FIREBASE ====== */
        .connection-badge {
            position: fixed;
            top: 15px;
            right: 15px;
            padding: 8px 15px;
            border-radius: 25px;
            font-size: 0.8rem;
            font-weight: 700;
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .connection-online {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
        }
        
        .connection-offline {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }
        
        /* ====== WHATSAPP BUTTON VERDE ====== */
        .whatsapp-btn {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
        }
        
        .whatsapp-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 211, 102, 0.4);
            color: white;
        }
        
        /* ====== RESPONSIVE ====== */
        @media (max-width: 768px) {
            .navbar-brand {
                font-size: 1.5rem;
            }
            
            .stat-number {
                font-size: 2.2rem;
            }
            
            .btn-primary {
                padding: 10px 20px;
            }
            
            .connection-badge {
                top: 10px;
                right: 10px;
                font-size: 0.7rem;
                padding: 6px 12px;
            }
        }
        
        /* ====== LOGIN SCREEN ESPECIAL ====== */
        .login-screen {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .login-card {
            background: white;
            border-radius: 20px;
            padding: 40px 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            width: 100%;
            max-width: 450px;
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-logo-icon {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            box-shadow: 0 10px 20px rgba(231, 76, 60, 0.3);
        }
        
        .login-logo-icon i {
            font-size: 2.5rem;
            color: white;
        }
        
        .login-title {
            color: var(--primary);
            font-weight: 800;
            font-size: 2.2rem;
            text-align: center;
            margin-bottom: 5px;
        }
        
        .login-subtitle {
            color: var(--gray);
            text-align: center;
            font-size: 1rem;
            margin-bottom: 30px;
        }
    </style>
    
    <!-- Firebase SDK tradicional (compatible con GitHub Pages) -->
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js"></script>

<script>
    // üî• TUS CREDENCIALES ACTUALES
    const firebaseConfig = {
        apiKey: "AIzaSyDxD4g_uYEUKB37uNHvDWus_NQHoSAMK_8",
        authDomain: "rapidsend-1f640.firebaseapp.com",
        projectId: "rapidsend-1f640",
        storageBucket: "rapidsend-1f640.firebasestorage.app",
        messagingSenderId: "249514582496",
        appId: "1:249514582496:web:cafcc8760282983f24cb85"
    };

    // Inicializar Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Hacer disponible globalmente
    window.firebaseAuth = auth;
    window.firebaseDB = db;
    window.firebaseModules = {
        auth: firebase.auth,
        firestore: firebase.firestore
    };

    console.log('üî• Firebase inicializado - RapidSend Red');
    
    // Actualizar estado de conexi√≥n
    function updateConnectionStatus(connected) {
        let badge = document.getElementById('connectionBadge');
        if (!badge) {
            badge = document.createElement('div');
            badge.id = 'connectionBadge';
            badge.className = 'connection-badge';
            document.body.appendChild(badge);
        }
        
        if (connected) {
            badge.innerHTML = '<i class="fas fa-bolt"></i> Conectado';
            badge.className = 'connection-badge connection-online';
        } else {
            badge.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Sin conexi√≥n';
            badge.className = 'connection-badge connection-offline';
        }
    }
    
    // Prueba inicial de conexi√≥n
    setTimeout(() => updateConnectionStatus(true), 1000);
</script>
</head>
<body>
    <!-- Estado de conexi√≥n -->
    <div id="connectionBadge" class="connection-badge connection-online" style="display: none;">
        <i class="fas fa-bolt"></i> Conectado
    </div>
    
    <div id="app">
        <!-- Loading inicial -->
        <div class="login-screen">
            <div class="login-card">
                <div class="login-logo">
                    <div class="login-logo-icon">
                        <i class="fas fa-bolt"></i>
                    </div>
                    <h1 class="login-title">RapidSend</h1>
                    <p class="login-subtitle">Entregas Express</p>
                    <span class="badge badge-rapidsend">v2.0</span>
                </div>
                
                <div class="text-center">
                    <div class="loading-spinner"></div>
                    <p class="mt-3 text-muted">Inicializando aplicaci√≥n...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap & SweetAlert -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        // ============================================
        // ESTADO Y CONFIGURACI√ìN
        // ============================================
        const AppState = {
            currentUser: null,
            userData: null,
            userRole: null,
            firebaseReady: false
        };

        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ RapidSend - Iniciando...');
            
            // Mostrar badge de conexi√≥n
            document.getElementById('connectionBadge').style.display = 'flex';
            
            await waitForFirebase();
            setupAuth();
        });

        async function waitForFirebase() {
            return new Promise((resolve) => {
                const check = () => {
                    if (window.firebaseAuth && window.firebaseDB) {
                        AppState.firebaseReady = true;
                        console.log('‚úÖ Firebase listo');
                        resolve();
                    } else {
                        setTimeout(check, 100);
                    }
                };
                check();
            });
        }

        function setupAuth() {
            window.firebaseModules.auth.onAuthStateChanged(window.firebaseAuth, async (user) => {
                AppState.currentUser = user;
                
                if (user) {
                    console.log('üë§ Usuario:', user.email);
                    await loadUserData(user.uid);
                    renderDashboard();
                } else {
                    renderLogin();
                }
            });
        }

        async function loadUserData(uid) {
            try {
                const userDoc = await window.firebaseModules.firestore.getDoc(
                    window.firebaseModules.firestore.doc(window.firebaseDB, 'usuarios', uid)
                );
                
                if (userDoc.exists()) {
                    AppState.userData = userDoc.data();
                    AppState.userRole = AppState.userData.rol;
                    localStorage.setItem('rapidsend_user', JSON.stringify({
                        uid: uid,
                        role: AppState.userRole,
                        data: AppState.userData
                    }));
                } else {
                    await createUserDocument(uid);
                }
            } catch (error) {
                console.error('Error cargando usuario:', error);
            }
        }

        async function createUserDocument(uid) {
            const user = window.firebaseAuth.currentUser;
            await window.firebaseModules.firestore.setDoc(
                window.firebaseModules.firestore.doc(window.firebaseDB, 'usuarios', uid),
                {
                    nombre: user.displayName || 'Usuario',
                    email: user.email,
                    rol: 'cliente',
                    telefono: '',
                    fechaRegistro: window.firebaseModules.firestore.serverTimestamp()
                }
            );
            AppState.userData = { nombre: user.displayName, email: user.email, rol: 'cliente' };
            AppState.userRole = 'cliente';
        }

        // ============================================
        // LOGIN/REGISTRO (DISE√ëO ROJO ORIGINAL)
        // ============================================
        function renderLogin() {
            document.getElementById('app').innerHTML = `
                <div class="login-screen">
                    <div class="login-card">
                        <div class="login-logo">
                            <div class="login-logo-icon">
                                <i class="fas fa-bolt"></i>
                            </div>
                            <h1 class="login-title">RapidSend</h1>
                            <p class="login-subtitle">Entregas Express en Panam√°</p>
                            <span class="badge badge-rapidsend">Nuevas Credenciales</span>
                        </div>

                        <!-- Pesta√±as -->
                        <ul class="nav nav-pills nav-fill mb-4" id="authTab">
                            <li class="nav-item">
                                <button class="nav-link active" onclick="showAuthTab('login')">Iniciar Sesi√≥n</button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" onclick="showAuthTab('register')">Registrarse</button>
                            </li>
                        </ul>

                        <!-- Formulario Login -->
                        <div id="loginForm">
                            <div class="mb-3">
                                <input type="email" class="form-control" id="loginEmail" placeholder="Correo electr√≥nico">
                            </div>
                            
                            <div class="mb-4">
                                <input type="password" class="form-control" id="loginPassword" placeholder="Contrase√±a">
                            </div>
                            
                            <button onclick="loginWithEmail()" class="btn btn-primary w-100 mb-3">
                                <i class="fas fa-sign-in-alt me-2"></i>Iniciar Sesi√≥n
                            </button>
                            
                            <div class="text-center">
                                <button onclick="quickDemo()" class="btn btn-outline-primary w-100">
                                    <i class="fas fa-rocket me-2"></i>Modo Demo
                                </button>
                            </div>
                        </div>

                        <!-- Formulario Registro -->
                        <div id="registerForm" style="display: none;">
                            <div class="mb-3">
                                <input type="text" class="form-control" id="regName" placeholder="Nombre completo">
                            </div>
                            
                            <div class="mb-3">
                                <input type="email" class="form-control" id="regEmail" placeholder="Correo electr√≥nico">
                            </div>
                            
                            <div class="mb-3">
                                <input type="password" class="form-control" id="regPassword" placeholder="Contrase√±a (m√≠nimo 6 caracteres)">
                            </div>
                            
                            <div class="mb-3">
                                <div class="input-group">
                                    <span class="input-group-text">+507</span>
                                    <input type="tel" class="form-control" id="regPhone" placeholder="WhatsApp">
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <select class="form-select" id="regRole">
                                    <option value="cliente">üë§ Soy Cliente</option>
                                    <option value="repartidor">üèçÔ∏è Soy Repartidor</option>
                                </select>
                            </div>
                            
                            <button onclick="registerWithEmail()" class="btn btn-primary w-100 mb-3">
                                <i class="fas fa-user-plus me-2"></i>Crear Cuenta
                            </button>
                        </div>
                        
                        <div class="text-center mt-4">
                            <small class="text-muted">Firebase: ${firebaseConfig.projectId}</small>
                        </div>
                    </div>
                </div>
            `;
            
            // Agregar event listeners despu√©s de renderizar
            setTimeout(() => {
                const loginBtn = document.getElementById('loginForm')?.querySelector('button');
                const registerBtn = document.getElementById('registerForm')?.querySelector('button');
                
                if (loginBtn) {
                    loginBtn.addEventListener('click', loginWithEmail);
                }
                if (registerBtn) {
                    registerBtn.addEventListener('click', registerWithEmail);
                }
                
                // Agregar event listeners para las pesta√±as
                const tabButtons = document.querySelectorAll('#authTab .nav-link');
                tabButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const tab = this.textContent.includes('Iniciar') ? 'login' : 'register';
                        showAuthTab(tab);
                    });
                });
                
                // Permitir Enter en los formularios
                document.getElementById('loginPassword')?.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') loginWithEmail();
                });
                
                document.getElementById('regPassword')?.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') registerWithEmail();
                });
                
                // Agregar bot√≥n demo
                const demoBtn = document.querySelector('button[onclick*="quickDemo"]');
                if (demoBtn) {
                    demoBtn.addEventListener('click', quickDemo);
                }
            }, 100);
        }

        function showAuthTab(tab) {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const loginTab = document.querySelector('#authTab .nav-link:first-child');
            const registerTab = document.querySelector('#authTab .nav-link:last-child');
            
            if (loginForm && registerForm && loginTab && registerTab) {
                if (tab === 'login') {
                    loginForm.style.display = 'block';
                    registerForm.style.display = 'none';
                    loginTab.classList.add('active');
                    registerTab.classList.remove('active');
                } else {
                    loginForm.style.display = 'none';
                    registerForm.style.display = 'block';
                    loginTab.classList.remove('active');
                    registerTab.classList.add('active');
                }
            }
        }

        async function loginWithEmail() {
            const email = document.getElementById('loginEmail')?.value || '';
            const password = document.getElementById('loginPassword')?.value || '';
            
            if (!email || !password) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Campos incompletos',
                    text: 'Por favor ingresa tu correo y contrase√±a',
                    confirmButtonColor: 'var(--primary)',
                    background: 'white'
                });
                return;
            }
            
            try {
                Swal.fire({
                    title: 'Iniciando sesi√≥n...',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading(),
                    background: 'white'
                });
                
                await window.firebaseModules.auth.signInWithEmailAndPassword(
                    window.firebaseAuth, 
                    email, 
                    password
                );
                
                Swal.fire({
                    icon: 'success',
                    title: '¬°Bienvenido!',
                    text: 'Sesi√≥n iniciada correctamente',
                    confirmButtonColor: 'var(--primary)',
                    background: 'white',
                    timer: 1500
                });
                
            } catch (error) {
                let errorMessage = 'Error al iniciar sesi√≥n';
                if (error.code === 'auth/invalid-credential') {
                    errorMessage = 'Correo o contrase√±a incorrectos';
                } else if (error.code === 'auth/user-not-found') {
                    errorMessage = 'Usuario no encontrado';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Contrase√±a incorrecta';
                } else {
                    errorMessage = error.message;
                }
                
                Swal.fire({
                    icon: 'error',
                    title: 'Error de inicio de sesi√≥n',
                    text: errorMessage,
                    confirmButtonColor: 'var(--primary)',
                    background: 'white'
                });
            }
        }

        async function registerWithEmail() {
            const name = document.getElementById('regName')?.value || '';
            const email = document.getElementById('regEmail')?.value || '';
            const password = document.getElementById('regPassword')?.value || '';
            const phone = document.getElementById('regPhone')?.value || '';
            const roleSelect = document.getElementById('regRole');
            const role = roleSelect ? roleSelect.value : 'cliente';
            
            // Validaciones
            if (!name || !email || !password || !phone) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Campos incompletos',
                    text: 'Por favor completa todos los campos',
                    confirmButtonColor: 'var(--primary)',
                    background: 'white'
                });
                return;
            }
            
            if (password.length < 6) {
                Swal.fire({
                    icon: 'error',
                    title: 'Contrase√±a muy corta',
                    text: 'La contrase√±a debe tener al menos 6 caracteres',
                    confirmButtonColor: 'var(--primary)',
                    background: 'white'
                });
                return;
            }
            
            // Validar email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                Swal.fire({
                    icon: 'error',
                    title: 'Email inv√°lido',
                    text: 'Por favor ingresa un correo electr√≥nico v√°lido',
                    confirmButtonColor: 'var(--primary)',
                    background: 'white'
                });
                return;
            }
            
            try {
                Swal.fire({
                    title: 'Creando cuenta...',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading(),
                    background: 'white'
                });
                
                // 1. Crear usuario en Authentication
                const userCredential = await window.firebaseModules.auth.createUserWithEmailAndPassword(
                    window.firebaseAuth,
                    email,
                    password
                );
                
                const user = userCredential.user;
                
                // 2. Actualizar perfil con nombre
                await user.updateProfile({ displayName: name });
                
                // 3. Crear documento en Firestore
                await window.firebaseModules.firestore.setDoc(
                    window.firebaseModules.firestore.doc(window.firebaseDB, 'usuarios', user.uid),
                    {
                        nombre: name,
                        email: email,
                        rol: role,
                        telefono: `+507${phone.replace(/\D/g, '')}`,
                        fechaRegistro: window.firebaseModules.firestore.serverTimestamp(),
                        activo: role === 'repartidor' ? true : null,
                        lastActive: window.firebaseModules.firestore.serverTimestamp()
                    }
                );
                
                Swal.fire({
                    icon: 'success',
                    title: '¬°Cuenta creada!',
                    text: 'Tu cuenta ha sido creada exitosamente',
                    confirmButtonColor: 'var(--primary)',
                    background: 'white',
                    timer: 2000
                });
                
            } catch (error) {
                let errorMessage = 'Error al crear la cuenta';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Este correo ya est√° registrado';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'La contrase√±a es muy d√©bil';
                } else {
                    errorMessage = error.message;
                }
                
                Swal.fire({
                    icon: 'error',
                    title: 'Error al registrar',
                    text: errorMessage,
                    confirmButtonColor: 'var(--primary)',
                    background: 'white'
                });
            }
        }

        async function quickDemo() {
            try {
                Swal.fire({
                    title: 'Iniciando modo demo...',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading(),
                    background: 'white'
                });
                
                await window.firebaseModules.auth.signInWithEmailAndPassword(
                    window.firebaseAuth,
                    'demo@rapidsend.com',
                    'demo123456'
                );
                
            } catch (error) {
                if (error.code === 'auth/user-not-found') {
                    await createDemoUser();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error demo',
                        text: error.message,
                        confirmButtonColor: 'var(--primary)',
                        background: 'white'
                    });
                }
            }
        }

        async function createDemoUser() {
            try {
                Swal.fire({
                    title: 'Creando cuenta demo...',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading(),
                    background: 'white'
                });
                
                const result = await window.firebaseModules.auth.createUserWithEmailAndPassword(
                    window.firebaseAuth,
                    'demo@rapidsend.com',
                    'demo123456'
                );
                
                await result.user.updateProfile({ 
                    displayName: 'Usuario Demo' 
                });
                
                await window.firebaseModules.firestore.setDoc(
                    window.firebaseModules.firestore.doc(window.firebaseDB, 'usuarios', result.user.uid),
                    {
                        nombre: 'Usuario Demo',
                        email: 'demo@rapidsend.com',
                        rol: 'cliente',
                        telefono: '+50760000000',
                        fechaRegistro: window.firebaseModules.firestore.serverTimestamp(),
                        activo: true
                    }
                );
                
                Swal.fire({
                    icon: 'success',
                    title: '‚úÖ Demo creado',
                    text: 'Ahora puedes explorar RapidSend',
                    confirmButtonColor: 'var(--primary)',
                    background: 'white',
                    timer: 2000
                });
                
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error al crear demo',
                    text: error.message,
                    confirmButtonColor: 'var(--primary)',
                    background: 'white'
                });
            }
        }

        // ============================================
        // DASHBOARD PRINCIPAL (DISE√ëO ROJO)
        // ============================================
        function renderDashboard() {
            document.getElementById('app').innerHTML = `
                <!-- Navbar Roja -->
                <nav class="navbar navbar-main navbar-expand-lg">
                    <div class="container-fluid">
                        <a class="navbar-brand" href="#">
                            <i class="fas fa-bolt me-2"></i>RapidSend
                            ${AppState.userRole === 'repartidor' ? 
                                '<span class="badge bg-light text-dark ms-2">Repartidor</span>' : 
                                '<span class="badge bg-light text-dark ms-2">Cliente</span>'
                            }
                        </a>
                        
                        <div class="d-flex align-items-center gap-3">
                            <div class="dropdown">
                                <button class="btn btn-light dropdown-toggle" data-bs-toggle="dropdown">
                                    <i class="fas fa-user me-2"></i>${AppState.userData?.nombre || 'Usuario'}
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="showProfile()">
                                        <i class="fas fa-id-card me-2"></i>Mi Perfil
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="testFirebase()">
                                        <i class="fas fa-vial me-2"></i>Probar Firebase
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="logout()">
                                        <i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesi√≥n
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </nav>

                <!-- Contenido Principal -->
                <div class="container-fluid py-4">
                    <!-- Bienvenida -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card-main">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h2 class="title-red">¬°Bienvenido a RapidSend!</h2>
                                            <p class="text-muted mb-4">Tu plataforma de entregas express est√° lista para usar.</p>
                                            
                                            <div class="d-flex flex-wrap gap-3">
                                                <button class="btn btn-primary" onclick="createTestOrder()">
                                                    <i class="fas fa-plus me-2"></i>Crear Pedido Test
                                                </button>
                                                <button class="btn btn-outline-primary" onclick="checkDatabase()">
                                                    <i class="fas fa-database me-2"></i>Ver Base de Datos
                                                </button>
                                                ${AppState.userRole === 'repartidor' ? `
                                                    <button class="btn btn-success" onclick="toggleOnlineStatus()">
                                                        <i class="fas fa-toggle-on me-2"></i>En L√≠nea
                                                    </button>
                                                ` : ''}
                                            </div>
                                        </div>
                                        <div class="col-md-4 text-center">
                                            <div class="rounded-circle bg-primary d-inline-flex align-items-center justify-content-center" 
                                                 style="width: 120px; height: 120px;">
                                                <i class="fas ${AppState.userRole === 'cliente' ? 'fa-user' : 'fa-motorcycle'} fa-3x text-white"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Estad√≠sticas -->
                    <div class="row mb-4">
                        <div class="col-md-3 col-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-fire"></i>
                                </div>
                                <div class="stat-number" id="firebaseStatus">OK</div>
                                <div class="stat-label">Firebase</div>
                            </div>
                        </div>
                        
                        <div class="col-md-3 col-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-icon">
                                    ${AppState.userRole === 'cliente' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-motorcycle"></i>'}
                                </div>
                                <div class="stat-number">${AppState.userRole === 'cliente' ? 'üë§' : 'üèçÔ∏è'}</div>
                                <div class="stat-label">${AppState.userRole === 'cliente' ? 'Cliente' : 'Repartidor'}</div>
                            </div>
                        </div>
                        
                        <div class="col-md-3 col-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-box"></i>
                                </div>
                                <div class="stat-number text-primary" id="ordersCount">0</div>
                                <div class="stat-label">Pedidos</div>
                            </div>
                        </div>
                        
                        <div class="col-md-3 col-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="stat-number text-info" id="usersCount">0</div>
                                <div class="stat-label">Usuarios</div>
                            </div>
                        </div>
                    </div>

                    <!-- Funciones Principales -->
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card-main h-100">
                                <div class="card-body">
                                    <h5 class="title-red mb-4">Configuraci√≥n</h5>
                                    <div class="list-group list-group-flush">
                                        <button class="list-group-item list-group-item-action border-0 py-3" onclick="showProfile()">
                                            <i class="fas fa-user-cog me-3 text-primary"></i>Editar Perfil
                                        </button>
                                        <button class="list-group-item list-group-item-action border-0 py-3" onclick="showFirebaseConfig()">
                                            <i class="fas fa-fire me-3 text-primary"></i>Ver Configuraci√≥n
                                        </button>
                                        <button class="list-group-item list-group-item-action border-0 py-3" onclick="testAllServices()">
                                            <i class="fas fa-vial me-3 text-primary"></i>Probar Servicios
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-4">
                            <div class="card-main h-100">
                                <div class="card-body">
                                    <h5 class="title-red mb-4">Acciones R√°pidas</h5>
                                    <div class="d-grid gap-3">
                                        <button class="btn btn-primary btn-lg py-3" onclick="createNewOrder()">
                                            <i class="fas fa-shipping-fast me-2"></i>Nuevo Pedido
                                        </button>
                                        ${AppState.userRole === 'repartidor' ? `
                                            <button class="btn btn-success btn-lg py-3" onclick="findOrders()">
                                                <i class="fas fa-search me-2"></i>Buscar Pedidos
                                            </button>
                                        ` : `
                                            <button class="btn btn-outline-primary btn-lg py-3" onclick="viewMyOrders()">
                                                <i class="fas fa-list me-2"></i>Mis Pedidos
                                            </button>
                                        `}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Agregar event listeners despu√©s de renderizar
            setTimeout(() => {
                document.getElementById('btnLogout')?.addEventListener('click', logout);
                document.querySelector('button[onclick*="createTestOrder"]')?.addEventListener('click', createTestOrder);
                document.querySelector('button[onclick*="checkDatabase"]')?.addEventListener('click', checkDatabase);
                document.querySelector('button[onclick*="toggleOnlineStatus"]')?.addEventListener('click', toggleOnlineStatus);
                document.querySelector('button[onclick*="showProfile"]')?.addEventListener('click', showProfile);
                document.querySelector('button[onclick*="testFirebase"]')?.addEventListener('click', testFirebase);
                document.querySelector('button[onclick*="testAllServices"]')?.addEventListener('click', testAllServices);
                document.querySelector('button[onclick*="createNewOrder"]')?.addEventListener('click', createNewOrder);
                document.querySelector('button[onclick*="findOrders"]')?.addEventListener('click', findOrders);
                document.querySelector('button[onclick*="viewMyOrders"]')?.addEventListener('click', viewMyOrders);
                
                // Inicializar dropdowns de Bootstrap
                const dropdowns = document.querySelectorAll('.dropdown-toggle');
                dropdowns.forEach(dropdown => {
                    new bootstrap.Dropdown(dropdown);
                });
                
                loadDashboardStats();
            }, 100);
        }

        async function loadDashboardStats() {
            try {
                // Contar usuarios
                const usersSnapshot = await window.firebaseModules.firestore.getDocs(
                    window.firebaseModules.firestore.collection(window.firebaseDB, 'usuarios')
                );
                document.getElementById('usersCount').textContent = usersSnapshot.size;
                
                // Contar pedidos del usuario
                const ordersQuery = window.firebaseModules.firestore.query(
                    window.firebaseModules.firestore.collection(window.firebaseDB, 'pedidos'),
                    window.firebaseModules.firestore.where('clienteId', '==', AppState.currentUser.uid)
                );
                const ordersSnapshot = await window.firebaseModules.firestore.getDocs(ordersQuery);
                document.getElementById('ordersCount').textContent = ordersSnapshot.size;
                
            } catch (error) {
                console.error('Error estad√≠sticas:', error);
            }
        }

        // ============================================
        // FUNCIONES PRINCIPALES
        // ============================================
        async function createTestOrder() {
            try {
                const orderData = {
                    clienteId: AppState.currentUser.uid,
                    clienteNombre: AppState.userData?.nombre || 'Cliente',
                    descripcion: 'Pedido de prueba - Documentos importantes',
                    origen: 'Calle 50, Panam√°',
                    destino: 'V√≠a Espa√±a, Panam√°',
                    urgencia: 'standard',
                    precio: 15.50,
                    status: 'pending',
                    createdAt: window.firebaseModules.firestore.serverTimestamp()
                };
                
                await window.firebaseModules.firestore.addDoc(
                    window.firebaseModules.firestore.collection(window.firebaseDB, 'pedidos'),
                    orderData
                );
                
                Swal.fire({
                    title: '‚úÖ Pedido creado',
                    text: 'Pedido de prueba agregado a la base de datos',
                    icon: 'success',
                    background: 'white',
                    color: '#333'
                });
                
                loadDashboardStats();
                
            } catch (error) {
                Swal.fire('Error', error.message, 'error');
            }
        }

        function checkDatabase() {
            Swal.fire({
                title: 'Estado de la Base de Datos',
                html: `
                    <div class="text-start">
                        <p><i class="fas fa-check-circle text-success"></i> Firebase conectado</p>
                        <p><i class="fas fa-database text-primary"></i> Proyecto: ${firebaseConfig.projectId}</p>
                        <p><i class="fas fa-user-check text-info"></i> Usuario: ${AppState.currentUser?.email}</p>
                        <hr>
                        <p class="small text-muted">Colecciones disponibles:</p>
                        <ul class="small">
                            <li>usuarios (datos de usuarios)</li>
                            <li>pedidos (registro de pedidos)</li>
                            <li>notificaciones (mensajes del sistema)</li>
                        </ul>
                    </div>
                `,
                background: 'white',
                color: '#333'
            });
        }

        async function testFirebase() {
            try {
                await window.firebaseModules.firestore.addDoc(
                    window.firebaseModules.firestore.collection(window.firebaseDB, 'test_logs'),
                    {
                        test: 'Prueba de Firebase',
                        timestamp: window.firebaseModules.firestore.serverTimestamp(),
                        user: AppState.currentUser.email
                    }
                );
                
                Swal.fire('‚úÖ Firebase funciona', 'Se escribi√≥ un documento de prueba', 'success');
                
            } catch (error) {
                Swal.fire('‚ùå Error', error.message, 'error');
            }
        }

        async function testAllServices() {
            Swal.fire({
                title: 'üß™ Probando servicios...',
                html: '<div class="loading-spinner"></div>',
                showConfirmButton: false,
                allowOutsideClick: false
            });
            
            try {
                // Test Auth
                const user = window.firebaseAuth.currentUser;
                
                // Test Firestore write
                await window.firebaseModules.firestore.addDoc(
                    window.firebaseModules.firestore.collection(window.firebaseDB, 'test_logs'),
                    {
                        service: 'Firestore Write Test',
                        user: user.email,
                        timestamp: window.firebaseModules.firestore.serverTimestamp()
                    }
                );
                
                // Test Firestore read
                const usersSnapshot = await window.firebaseModules.firestore.getDocs(
                    window.firebaseModules.firestore.collection(window.firebaseDB, 'usuarios')
                );
                
                Swal.fire({
                    title: '‚úÖ Todos los servicios funcionan',
                    html: `
                        <div class="text-start">
                            <p><i class="fas fa-check-circle text-success"></i> Authentication: OK</p>
                            <p><i class="fas fa-check-circle text-success"></i> Firestore Write: OK</p>
                            <p><i class="fas fa-check-circle text-success"></i> Firestore Read: ${usersSnapshot.size} usuarios</p>
                            <p><i class="fas fa-check-circle text-success"></i> Local Storage: OK</p>
                        </div>
                    `,
                    icon: 'success'
                });
                
            } catch (error) {
                Swal.fire('‚ùå Error en pruebas', error.message, 'error');
            }
        }

        function showProfile() {
            Swal.fire({
                title: 'Mi Perfil',
                html: `
                    <div class="text-center">
                        <div class="rounded-circle bg-primary d-inline-flex align-items-center justify-content-center mb-3" 
                             style="width: 100px; height: 100px;">
                            <i class="fas fa-user fa-3x text-white"></i>
                        </div>
                        
                        <h5 class="fw-bold">${AppState.userData?.nombre || 'Usuario'}</h5>
                        <p class="text-muted">${AppState.userData?.email || ''}</p>
                        
                        <div class="text-start mt-4">
                            <p><strong><i class="fas fa-id-card me-2"></i>Rol:</strong> 
                               <span class="badge ${AppState.userRole === 'cliente' ? 'bg-primary' : 'bg-success'}">
                                   ${AppState.userRole === 'cliente' ? 'Cliente' : 'Repartidor'}
                               </span>
                            </p>
                            <p><strong><i class="fas fa-phone me-2"></i>WhatsApp:</strong> ${AppState.userData?.telefono || 'No registrado'}</p>
                            <p><strong><i class="fas fa-fire me-2"></i>Firebase ID:</strong> 
                               <small class="text-muted">${AppState.currentUser?.uid?.substring(0, 15)}...</small>
                            </p>
                        </div>
                    </div>
                `,
                background: 'white',
                showConfirmButton: false,
                showCloseButton: true
            });
        }

        function showFirebaseConfig() {
            Swal.fire({
                title: 'Configuraci√≥n Firebase',
                html: `
                    <div class="text-start">
                        <p><strong>Proyecto:</strong> ${firebaseConfig.projectId}</p>
                        <p><strong>App ID:</strong> ${firebaseConfig.appId}</p>
                        <p><strong>Auth Domain:</strong> ${firebaseConfig.authDomain}</p>
                        <p><strong>API Key:</strong> 
                           <span class="text-success">Nueva y segura ‚úÖ</span>
                        </p>
                        <hr>
                        <p class="small text-muted">
                            <i class="fas fa-info-circle"></i> Esta clave API es diferente a la anterior comprometida.
                        </p>
                    </div>
                `,
                width: 500,
                background: 'white'
            });
        }

        function createNewOrder() {
            Swal.fire({
                title: 'üì¶ Nuevo Pedido',
                html: `
                    <div class="text-start">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="orderDesc" placeholder="¬øQu√© vas a enviar?">
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <input type="text" class="form-control" id="orderFrom" placeholder="Origen">
                            </div>
                            <div class="col-md-6">
                                <input type="text" class="form-control" id="orderTo" placeholder="Destino">
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <input type="number" class="form-control" id="orderPrice" value="10" placeholder="Precio ($)">
                            </div>
                            <div class="col-md-6">
                                <select class="form-select" id="orderUrgency">
                                    <option value="standard">Normal</option>
                                    <option value="express">Express</option>
                                    <option value="urgent">Urgente</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Crear Pedido',
                cancelButtonText: 'Cancelar',
                background: 'white',
                preConfirm: () => {
                    const desc = document.getElementById('orderDesc').value;
                    const from = document.getElementById('orderFrom').value;
                    const to = document.getElementById('orderTo').value;
                    const price = document.getElementById('orderPrice').value;
                    
                    if (!desc || !from || !to) {
                        Swal.showValidationMessage('Completa todos los campos');
                        return false;
                    }
                    
                    return { desc, from, to, price };
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    await createOrder(result.value);
                }
            });
        }

        async function createOrder(data) {
            try {
                const orderData = {
                    clienteId: AppState.currentUser.uid,
                    clienteNombre: AppState.userData?.nombre || 'Cliente',
                    descripcion: data.desc,
                    origen: data.from,
                    destino: data.to,
                    urgencia: document.getElementById('orderUrgency').value,
                    precio: parseFloat(data.price),
                    metodoPago: 'cash',
                    status: 'pending',
                    createdAt: window.firebaseModules.firestore.serverTimestamp()
                };
                
                await window.firebaseModules.firestore.addDoc(
                    window.firebaseModules.firestore.collection(window.firebaseDB, 'pedidos'),
                    orderData
                );
                
                Swal.fire('‚úÖ Pedido publicado', 'Los repartidores ser√°n notificados', 'success');
                loadDashboardStats();
                
            } catch (error) {
                Swal.fire('Error', error.message, 'error');
            }
        }

        async function toggleOnlineStatus() {
            if (!AppState.userData) return;
            
            const newStatus = !AppState.userData.activo;
            
            try {
                await window.firebaseModules.firestore.updateDoc(
                    window.firebaseModules.firestore.doc(window.firebaseDB, 'usuarios', AppState.currentUser.uid),
                    {
                        activo: newStatus,
                        lastActive: window.firebaseModules.firestore.serverTimestamp()
                    }
                );
                
                AppState.userData.activo = newStatus;
                
                Swal.fire(
                    newStatus ? 'üü¢ En l√≠nea' : 'üî¥ Desconectado',
                    `Estado actualizado a ${newStatus ? 'en l√≠nea' : 'desconectado'}`,
                    'success'
                );
                
            } catch (error) {
                Swal.fire('Error', error.message, 'error');
            }
        }

        function findOrders() {
            Swal.fire('Modo Repartidor', 'Buscando pedidos disponibles...', 'info');
        }

        function viewMyOrders() {
            Swal.fire('Mis Pedidos', 'Aqu√≠ ver√°s tu historial de pedidos', 'info');
        }

        async function logout() {
            try {
                Swal.fire({
                    title: 'Cerrando sesi√≥n...',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading(),
                    background: 'white'
                });
                
                await window.firebaseModules.auth.signOut(window.firebaseAuth);
                localStorage.removeItem('rapidsend_user');
                
                Swal.fire({
                    icon: 'success',
                    title: 'Sesi√≥n cerrada',
                    text: 'Has cerrado sesi√≥n correctamente',
                    confirmButtonColor: 'var(--primary)',
                    background: 'white',
                    timer: 1500
                });
                
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudo cerrar sesi√≥n: ' + error.message,
                    confirmButtonColor: 'var(--primary)',
                    background: 'white'
                });
            }
        }

        console.log('‚ú® RapidSend - Aplicaci√≥n lista');
    </script>
</body>
</html>
