<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RapidSend - Entregas Express</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Leaflet Maps -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --dark: #1a1a2e;
            --light: #f8f9fa;
            --gray: #6c757d;
            --gray-light: #e9ecef;
            --card-bg: #ffffff;
            --card-shadow: 0 2px 15px rgba(0,0,0,0.08);
            --border-radius: 12px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            min-height: 100vh;
        }
        
        /* Navbar */
        .navbar-main {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1rem 0;
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--primary);
        }
        
        /* Cards */
        .card-main {
            background: var(--card-bg);
            border: none;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card-main:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.12);
        }
        
        /* Buttons */
        .btn-primary {
            background: var(--primary);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
        }
        
        .btn-success {
            background: var(--success);
            border: none;
        }
        
        .btn-danger {
            background: var(--danger);
            border: none;
        }
        
        .btn-warning {
            background: var(--warning);
            border: none;
            color: white;
        }
        
        /* Badges */
        .badge-urgent {
            background: linear-gradient(135deg, var(--danger), #c0392b);
            color: white;
        }
        
        .badge-express {
            background: linear-gradient(135deg, var(--warning), #d35400);
            color: white;
        }
        
        .badge-standard {
            background: linear-gradient(135deg, var(--success), #27ae60);
            color: white;
        }
        
        /* Map */
        .map-container {
            height: 400px;
            border-radius: var(--border-radius);
            overflow: hidden;
            border: 2px solid var(--gray-light);
            background: white;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        /* Forms */
        .form-control {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 12px 15px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        
        .form-label {
            font-weight: 600;
            color: #555;
            margin-bottom: 8px;
        }
        
        /* Order Cards */
        .order-card {
            background: white;
            border-left: 4px solid var(--primary);
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }
        
        .order-card.urgent {
            border-left-color: var(--danger);
            background: linear-gradient(to right, rgba(231, 76, 60, 0.05), white);
        }
        
        .order-card.express {
            border-left-color: var(--warning);
            background: linear-gradient(to right, rgba(243, 156, 18, 0.05), white);
        }
        
        .order-card.standard {
            border-left-color: var(--success);
            background: linear-gradient(to right, rgba(46, 204, 113, 0.05), white);
        }
        
        /* Status Badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-accepted {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .status-picked {
            background: #d4edda;
            color: #155724;
        }
        
        .status-delivered {
            background: #d1f2eb;
            color: #0e6251;
        }
        
        /* Chat */
        .chat-container {
            height: 400px;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            background: #f8f9fa;
        }
        
        .message {
            max-width: 80%;
            margin-bottom: 1rem;
        }
        
        .message.sent {
            margin-left: auto;
        }
        
        .message-bubble {
            padding: 12px 16px;
            border-radius: 18px;
            background: white;
            border: 1px solid #e9ecef;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .message.sent .message-bubble {
            background: var(--primary);
            color: white;
            border: none;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .map-container {
                height: 300px;
            }
            
            .chat-container {
                height: 350px;
            }
            
            .order-card {
                padding: 1rem;
            }
            
            .navbar-brand {
                font-size: 1.2rem;
            }
            
            .btn {
                padding: 8px 16px;
                font-size: 14px;
            }
            
            .form-control {
                padding: 10px 12px;
                font-size: 14px;
            }
        }
        
        @media (max-width: 576px) {
            .container-fluid {
                padding-left: 15px;
                padding-right: 15px;
            }
            
            .card-main {
                margin: 0 -15px;
                border-radius: 0;
            }
            
            .map-container {
                height: 250px;
                border-radius: 0;
                margin: 0 -15px;
            }
        }
        
        /* Loading */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--gray);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #dee2e6;
        }
        
        /* WhatsApp Button */
        .whatsapp-btn {
            background: linear-gradient(135deg, #25D366, #128C7E);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .whatsapp-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
            color: white;
        }
        
        /* Payment Methods */
        .payment-method {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        
        .payment-method:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .payment-method.selected {
            border-color: var(--primary);
            background: rgba(67, 97, 238, 0.05);
        }
        
        /* Profile */
        .profile-pic {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Stats */
        .stat-card {
            text-align: center;
            padding: 1.5rem;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            line-height: 1;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: var(--gray);
            font-size: 0.9rem;
        }
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script>
        // üî• CONFIGURACI√ìN FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCZeApEnKqzvITD4HXeEQjSt8JEO8ohyWs",
            authDomain: "rapidsend-1f640.firebaseapp.com",
            projectId: "rapidsend-1f640",
            storageBucket: "rapidsend-1f640.firebasestorage.app",
            messagingSenderId: "249514582496",
            appId: "1:249514582496:web:33eb02da093b398824cb85"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
    </script>
</head>
<body>
    <div id="app"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        // ====================
        // ESTADO DE LA APLICACI√ìN
        // ====================
        const AppState = {
            currentUser: null,
            userRole: null,
            userData: null,
            currentOrderId: null,
            currentMap: null,
            currentRoute: null,
            markers: {},
            listeners: {}
        };

        // ====================
        // FUNCIONES DE MAPA MEJORADAS
        // ====================
        function initMap(containerId, options = {}) {
            const container = document.getElementById(containerId);
            if (!container) return null;
            
            container.innerHTML = '<div class="loading-spinner"></div>';
            
            setTimeout(() => {
                try {
                    const map = L.map(containerId).setView([9.0, -79.5], 13);
                    
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap',
                        maxZoom: 19
                    }).addTo(map);
                    
                    if (options.onClick) {
                        map.on('click', function(e) {
                            options.onClick(e.latlng, map);
                        });
                    }
                    
                    container.innerHTML = '';
                    map._container.id = containerId;
                    
                    AppState.currentMap = map;
                    return map;
                    
                } catch (error) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-map-marked-alt"></i>
                            <p>Error cargando el mapa</p>
                            <button onclick="initMap('${containerId}', ${JSON.stringify(options)})" 
                                    class="btn btn-primary btn-sm mt-2">
                                Reintentar
                            </button>
                        </div>
                    `;
                    return null;
                }
            }, 100);
        }

        function addMarker(lat, lng, title, color = 'blue') {
            if (!AppState.currentMap) return null;
            
            const marker = L.marker([lat, lng], {
                icon: L.divIcon({
                    html: `<div style="background: ${color}; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3);"></div>`,
                    className: 'custom-marker',
                    iconSize: [20, 20]
                })
            }).addTo(AppState.currentMap);
            
            if (title) {
                marker.bindPopup(title).openPopup();
            }
            
            return marker;
        }

        function calculateRoute(originLat, originLng, destLat, destLng) {
            if (!AppState.currentMap) return;
            
            // Limpiar ruta anterior
            if (AppState.currentRoute) {
                AppState.currentMap.removeControl(AppState.currentRoute);
            }
            
            // Crear nueva ruta
            AppState.currentRoute = L.Routing.control({
                waypoints: [
                    L.latLng(originLat, originLng),
                    L.latLng(destLat, destLng)
                ],
                routeWhileDragging: false,
                showAlternatives: false,
                fitSelectedRoutes: true,
                lineOptions: {
                    styles: [{color: '#4361ee', weight: 5, opacity: 0.7}]
                },
                createMarker: function() { return null; }
            }).addTo(AppState.currentMap);
            
            // Agregar bot√≥n de compartir ruta
            setTimeout(() => {
                const shareButton = L.control({position: 'topright'});
                shareButton.onAdd = function(map) {
                    const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                    div.innerHTML = `
                        <a href="#" title="Compartir ruta" 
                           style="background: white; color: #4361ee; padding: 10px; border-radius: 4px; display: block; text-decoration: none; font-weight: 600;"
                           onclick="shareRoute(${originLat}, ${originLng}, ${destLat}, ${destLng})">
                            <i class="fas fa-share-alt"></i> Compartir Ruta
                        </a>
                    `;
                    return div;
                };
                shareButton.addTo(AppState.currentMap);
            }, 1000);
        }

        function shareRoute(originLat, originLng, destLat, destLng) {
            const wazeUrl = `https://www.waze.com/ul?ll=${destLat},${destLng}&navigate=yes`;
            const googleUrl = `https://www.google.com/maps/dir/?api=1&origin=${originLat},${originLng}&destination=${destLat},${destLng}&travelmode=driving`;
            
            Swal.fire({
                title: 'Compartir Ruta',
                html: `
                    <div class="text-start">
                        <p>Selecciona la app de navegaci√≥n:</p>
                        <div class="d-grid gap-2 mt-3">
                            <a href="${wazeUrl}" target="_blank" class="btn btn-primary">
                                <i class="fab fa-waze me-2"></i>Abrir en Waze
                            </a>
                            <a href="${googleUrl}" target="_blank" class="btn btn-success">
                                <i class="fab fa-google me-2"></i>Abrir en Google Maps
                            </a>
                        </div>
                    </div>
                `,
                showConfirmButton: false,
                showCloseButton: true
            });
        }

        // ====================
        // SISTEMA DE PEDIDOS
        // ====================
        async function createOrder(orderData) {
            try {
                const orderRef = await db.collection('pedidos').add({
                    ...orderData,
                    clienteId: AppState.currentUser.uid,
                    clienteNombre: AppState.userData?.nombre || AppState.currentUser.displayName,
                    clienteTelefono: AppState.userData?.telefono || '',
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    repartidorId: null,
                    repartidorNombre: null,
                    repartidorTelefono: null
                });
                
                // Notificar a repartidores
                await notifyRepartidores(orderRef.id, orderData);
                
                return orderRef.id;
            } catch (error) {
                console.error('Error creando pedido:', error);
                throw error;
            }
        }

        async function acceptOrder(orderId) {
            try {
                const orderRef = db.collection('pedidos').doc(orderId);
                const repartidorData = AppState.userData;
                
                await orderRef.update({
                    status: 'accepted',
                    repartidorId: AppState.currentUser.uid,
                    repartidorNombre: repartidorData?.nombre || AppState.currentUser.displayName,
                    repartidorTelefono: repartidorData?.telefono || '',
                    acceptedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Notificar al cliente
                await notifyUser(orderId, 'accepted');
                
                // Calcular ruta si hay coordenadas
                const orderDoc = await orderRef.get();
                const order = orderDoc.data();
                
                if (order.origenLat && order.origenLng && order.destinoLat && order.destinoLng) {
                    setTimeout(() => {
                        calculateRoute(
                            order.origenLat,
                            order.origenLng,
                            order.destinoLat,
                            order.destinoLng
                        );
                    }, 500);
                }
                
                return true;
            } catch (error) {
                console.error('Error aceptando pedido:', error);
                throw error;
            }
        }

        async function updateOrderStatus(orderId, status) {
            try {
                const updates = {
                    status: status,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                switch(status) {
                    case 'picked':
                        updates.pickedAt = firebase.firestore.FieldValue.serverTimestamp();
                        break;
                    case 'delivered':
                        updates.deliveredAt = firebase.firestore.FieldValue.serverTimestamp();
                        break;
                }
                
                await db.collection('pedidos').doc(orderId).update(updates);
                
                // Notificar al otro usuario
                await notifyUser(orderId, 'status_update', { status });
                
                return true;
            } catch (error) {
                console.error('Error actualizando estado:', error);
                throw error;
            }
        }

        async function notifyRepartidores(orderId, orderData) {
            try {
                const repartidoresSnapshot = await db.collection('usuarios')
                    .where('rol', '==', 'repartidor')
                    .where('activo', '==', true)
                    .get();
                
                const batch = db.batch();
                
                repartidoresSnapshot.forEach(doc => {
                    const notifRef = db.collection('notificaciones').doc();
                    batch.set(notifRef, {
                        userId: doc.id,
                        type: 'new_order',
                        title: 'üì¶ Nuevo pedido disponible',
                        message: `${orderData.descripcion} - $${orderData.precio}`,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        read: false,
                        metadata: { orderId }
                    });
                });
                
                await batch.commit();
            } catch (error) {
                console.error('Error notificando repartidores:', error);
            }
        }

        async function notifyUser(orderId, type, data = {}) {
            try {
                const orderDoc = await db.collection('pedidos').doc(orderId).get();
                const order = orderDoc.data();
                
                const userId = type === 'accepted' ? order.clienteId : order.repartidorId;
                if (!userId) return;
                
                let title = '';
                let message = '';
                
                switch(type) {
                    case 'accepted':
                        title = '‚úÖ Pedido aceptado';
                        message = `${order.repartidorNombre} ha aceptado tu pedido`;
                        break;
                    case 'status_update':
                        title = 'üîÑ Estado actualizado';
                        message = `El pedido ahora est√°: ${data.status === 'picked' ? 'Recogido' : 'Entregado'}`;
                        break;
                }
                
                await db.collection('notificaciones').add({
                    userId: userId,
                    type: type,
                    title: title,
                    message: message,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    read: false,
                    metadata: { orderId }
                });
            } catch (error) {
                console.error('Error notificando usuario:', error);
            }
        }

        // ====================
        // SISTEMA DE CHAT
        // ====================
        async function openChat(orderId) {
            AppState.currentOrderId = orderId;
            
            const modalHTML = `
                <div class="modal fade" id="chatModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">üí¨ Chat del Pedido</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body p-0">
                                <div class="chat-container">
                                    <div class="chat-messages" id="chatMessages"></div>
                                    <div class="p-3 border-top">
                                        <div class="input-group">
                                            <input type="text" class="form-control" 
                                                   placeholder="Escribe un mensaje..." 
                                                   id="chatInput">
                                            <button class="btn btn-primary" onclick="sendMessage()">
                                                <i class="fas fa-paper-plane"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            if (!document.getElementById('chatModal')) {
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }
            
            const modal = new bootstrap.Modal(document.getElementById('chatModal'));
            modal.show();
            
            loadChatMessages(orderId);
            setupChatListener(orderId);
        }

        function setupChatListener(orderId) {
            if (AppState.listeners.chat) {
                AppState.listeners.chat();
            }
            
            AppState.listeners.chat = db.collection('chats')
                .doc(orderId)
                .collection('messages')
                .orderBy('timestamp', 'asc')
                .onSnapshot(snapshot => {
                    const messages = [];
                    snapshot.forEach(doc => {
                        messages.push({ id: doc.id, ...doc.data() });
                    });
                    renderChatMessages(messages);
                });
        }

        async function loadChatMessages(orderId) {
            try {
                const snapshot = await db.collection('chats')
                    .doc(orderId)
                    .collection('messages')
                    .orderBy('timestamp', 'asc')
                    .limit(50)
                    .get();
                
                const messages = [];
                snapshot.forEach(doc => {
                    messages.push({ id: doc.id, ...doc.data() });
                });
                
                renderChatMessages(messages);
            } catch (error) {
                console.error('Error cargando mensajes:', error);
            }
        }

        function renderChatMessages(messages) {
            const container = document.getElementById('chatMessages');
            if (!container) return;
            
            container.innerHTML = messages.map(msg => `
                <div class="message ${msg.senderId === AppState.currentUser.uid ? 'sent' : 'received'}">
                    <div class="message-bubble">
                        <small class="d-block fw-bold">${msg.senderName}</small>
                        <p class="mb-1">${msg.text}</p>
                        <small class="text-muted">
                            ${msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : ''}
                        </small>
                    </div>
                </div>
            `).join('');
            
            container.scrollTop = container.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message || !AppState.currentOrderId) return;
            
            try {
                await db.collection('chats')
                    .doc(AppState.currentOrderId)
                    .collection('messages')
                    .add({
                        senderId: AppState.currentUser.uid,
                        senderName: AppState.userData?.nombre || AppState.currentUser.displayName,
                        text: message,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                
                input.value = '';
                
            } catch (error) {
                console.error('Error enviando mensaje:', error);
                Swal.fire('Error', 'No se pudo enviar el mensaje', 'error');
            }
        }

        // ====================
        // INTERFAZ DE USUARIO
        // ====================
        function renderLogin() {
            document.getElementById('app').innerHTML = `
                <div class="min-vh-100 d-flex align-items-center justify-content-center p-3">
                    <div class="card-main animate__animated animate__fadeIn" style="width: 100%; max-width: 400px;">
                        <div class="card-body p-4">
                            <!-- Logo -->
                            <div class="text-center mb-4">
                                <div class="rounded-circle bg-primary d-inline-flex align-items-center justify-content-center mb-3" 
                                     style="width: 80px; height: 80px;">
                                    <i class="fas fa-bolt fa-2x text-white"></i>
                                </div>
                                <h2 class="fw-bold mb-2">RapidSend</h2>
                                <p class="text-muted">Entregas Express en Panam√°</p>
                            </div>

                            <!-- Tabs -->
                            <ul class="nav nav-pills nav-fill mb-4" id="authTab">
                                <li class="nav-item">
                                    <button class="nav-link active" onclick="showAuthTab('login')">Iniciar Sesi√≥n</button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link" onclick="showAuthTab('register')">Registrarse</button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link" onclick="loginDemo()">Demo R√°pido</button>
                                </li>
                            </ul>

                            <!-- Login Form -->
                            <div id="loginForm">
                                <div class="mb-3">
                                    <label class="form-label">Correo electr√≥nico</label>
                                    <input type="email" id="loginEmail" class="form-control" 
                                           placeholder="ejemplo@email.com">
                                </div>
                                
                                <div class="mb-4">
                                    <label class="form-label">Contrase√±a</label>
                                    <input type="password" id="loginPassword" class="form-control" 
                                           placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                </div>
                                
                                <button onclick="loginWithEmail()" class="btn btn-primary w-100 mb-3">
                                    <i class="fas fa-sign-in-alt me-2"></i>Iniciar Sesi√≥n
                                </button>
                            </div>

                            <!-- Register Form -->
                            <div id="registerForm" style="display: none;">
                                <div class="mb-3">
                                    <label class="form-label">Nombre completo</label>
                                    <input type="text" id="registerName" class="form-control" 
                                           placeholder="Tu nombre completo">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Correo electr√≥nico</label>
                                    <input type="email" id="registerEmail" class="form-control" 
                                           placeholder="ejemplo@email.com">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Contrase√±a</label>
                                    <input type="password" id="registerPassword" class="form-control" 
                                           placeholder="M√≠nimo 6 caracteres">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Tipo de usuario</label>
                                    <select id="registerRole" class="form-select">
                                        <option value="cliente">üë§ Soy Cliente</option>
                                        <option value="repartidor">üèçÔ∏è Soy Repartidor</option>
                                    </select>
                                </div>
                                
                                <div class="mb-4">
                                    <label class="form-label">üì± WhatsApp</label>
                                    <div class="input-group">
                                        <span class="input-group-text">+507</span>
                                        <input type="tel" id="registerPhone" class="form-control" 
                                               placeholder="6000 0000">
                                    </div>
                                </div>
                                
                                <button onclick="registerWithEmail()" class="btn btn-primary w-100">
                                    <i class="fas fa-user-plus me-2"></i>Crear Cuenta
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function showAuthTab(tab) {
            document.getElementById('loginForm').style.display = tab === 'login' ? 'block' : 'none';
            document.getElementById('registerForm').style.display = tab === 'register' ? 'block' : 'none';
        }

        async function loginDemo() {
            const { value: role } = await Swal.fire({
                title: 'Selecciona tipo de demo',
                input: 'select',
                inputOptions: {
                    'cliente': 'üë§ Cliente Demo',
                    'repartidor': 'üèçÔ∏è Repartidor Demo'
                },
                inputPlaceholder: 'Selecciona un rol',
                showCancelButton: true,
                confirmButtonText: 'Continuar',
                cancelButtonText: 'Cancelar'
            });
            
            if (role) {
                await loginDemoUser(role);
            }
        }

        async function loginDemoUser(role) {
            try {
                const email = role === 'cliente' ? 'cliente@demo.com' : 'repartidor@demo.com';
                const password = '123456';
                
                const result = await auth.signInWithEmailAndPassword(email, password);
                await loadUserData(result.user.uid);
                renderDashboard();
                
            } catch (error) {
                if (error.code === 'auth/user-not-found') {
                    await createDemoUser(role);
                } else {
                    Swal.fire('Error', error.message, 'error');
                }
            }
        }

        async function createDemoUser(role) {
            try {
                const email = role === 'cliente' ? 'cliente@demo.com' : 'repartidor@demo.com';
                const password = '123456';
                const name = role === 'cliente' ? 'Cliente Demo' : 'Repartidor Demo';
                
                const result = await auth.createUserWithEmailAndPassword(email, password);
                await result.user.updateProfile({ displayName: name });
                
                await db.collection('usuarios').doc(result.user.uid).set({
                    nombre: name,
                    email: email,
                    rol: role,
                    telefono: '+507 6000 0000',
                    fechaRegistro: firebase.firestore.FieldValue.serverTimestamp(),
                    activo: role === 'repartidor' ? true : null
                });
                
                await loadUserData(result.user.uid);
                renderDashboard();
                
            } catch (error) {
                Swal.fire('Error', 'No se pudo crear el usuario demo', 'error');
            }
        }

        async function loginWithEmail() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                Swal.fire('Error', 'Completa todos los campos', 'error');
                return;
            }
            
            try {
                const result = await auth.signInWithEmailAndPassword(email, password);
                await loadUserData(result.user.uid);
                renderDashboard();
            } catch (error) {
                Swal.fire('Error', error.message, 'error');
            }
        }

        async function registerWithEmail() {
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const role = document.getElementById('registerRole').value;
            const phone = document.getElementById('registerPhone').value;
            
            if (!name || !email || !password || !phone) {
                Swal.fire('Error', 'Completa todos los campos', 'error');
                return;
            }
            
            if (password.length < 6) {
                Swal.fire('Error', 'La contrase√±a debe tener al menos 6 caracteres', 'error');
                return;
            }
            
            try {
                const result = await auth.createUserWithEmailAndPassword(email, password);
                await result.user.updateProfile({ displayName: name });
                
                await db.collection('usuarios').doc(result.user.uid).set({
                    nombre: name,
                    email: email,
                    rol: role,
                    telefono: `+507${phone.replace(/\D/g, '')}`,
                    fechaRegistro: firebase.firestore.FieldValue.serverTimestamp(),
                    activo: role === 'repartidor' ? true : null
                });
                
                await loadUserData(result.user.uid);
                renderDashboard();
                
            } catch (error) {
                Swal.fire('Error', error.message, 'error');
            }
        }

        async function loadUserData(uid) {
            try {
                const doc = await db.collection('usuarios').doc(uid).get();
                if (doc.exists) {
                    AppState.userData = doc.data();
                    AppState.userRole = AppState.userData.rol;
                    
                    localStorage.setItem('rapidsend_user', JSON.stringify({
                        uid: uid,
                        role: AppState.userRole,
                        data: AppState.userData
                    }));
                }
            } catch (error) {
                console.error('Error cargando datos:', error);
            }
        }

        function renderDashboard() {
            if (AppState.userRole === 'cliente') {
                renderClienteDashboard();
            } else {
                renderRepartidorDashboard();
            }
            
            // Cargar datos iniciales
            loadDashboardData();
        }

        function renderClienteDashboard() {
            document.getElementById('app').innerHTML = `
                <!-- Navbar -->
                <nav class="navbar navbar-main navbar-expand-lg">
                    <div class="container-fluid">
                        <a class="navbar-brand" href="#">
                            <i class="fas fa-bolt me-2"></i>RapidSend
                        </a>
                        
                        <div class="d-flex align-items-center gap-3">
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#newOrderModal">
                                <i class="fas fa-plus me-1"></i>Nuevo Pedido
                            </button>
                            
                            <div class="dropdown">
                                <button class="btn btn-outline-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                                    <i class="fas fa-user me-1"></i> ${AppState.userData?.nombre || 'Usuario'}
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="showProfile()">Mi Perfil</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="showHistory()">Historial</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="logout()">Cerrar Sesi√≥n</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </nav>

                <!-- Modal Nuevo Pedido -->
                <div class="modal fade" id="newOrderModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Nuevo Pedido</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <!-- Mapa -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">üìç Selecciona ubicaciones en el mapa</label>
                                    <div class="map-container mb-3">
                                        <div id="newOrderMap"></div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">üè† Origen</label>
                                            <input type="text" id="orderOrigen" class="form-control" 
                                                   placeholder="Haz clic en el mapa" readonly>
                                            <input type="hidden" id="orderOrigenLat">
                                            <input type="hidden" id="orderOrigenLng">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">üéØ Destino</label>
                                            <input type="text" id="orderDestino" class="form-control" 
                                                   placeholder="Haz clic en el mapa" readonly>
                                            <input type="hidden" id="orderDestinoLat">
                                            <input type="hidden" id="orderDestinoLng">
                                        </div>
                                    </div>
                                </div>

                                <!-- Descripci√≥n -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">üì¶ ¬øQu√© vas a enviar?</label>
                                    <textarea id="orderDescripcion" class="form-control" 
                                              rows="2" placeholder="Describe el paquete o documento..."></textarea>
                                </div>

                                <!-- Urgencia -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">‚è±Ô∏è Urgencia</label>
                                    <div class="row g-2">
                                        <div class="col-4">
                                            <button type="button" class="btn btn-outline-danger w-100" 
                                                    onclick="selectUrgency('urgent')">
                                                <i class="fas fa-fire me-1"></i>Alta
                                            </button>
                                        </div>
                                        <div class="col-4">
                                            <button type="button" class="btn btn-outline-warning w-100" 
                                                    onclick="selectUrgency('express')">
                                                <i class="fas fa-clock me-1"></i>Media
                                            </button>
                                        </div>
                                        <div class="col-4">
                                            <button type="button" class="btn btn-outline-success w-100" 
                                                    onclick="selectUrgency('standard')">
                                                <i class="fas fa-walking me-1"></i>Normal
                                            </button>
                                        </div>
                                    </div>
                                    <input type="hidden" id="orderUrgency" value="standard">
                                </div>

                                <!-- Precio -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">üí∞ Precio ofrecido (USD)</label>
                                    <input type="number" id="orderPrecio" class="form-control" 
                                           min="3" max="100" value="10" step="0.5">
                                </div>

                                <!-- M√©todo de Pago -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">üí≥ M√©todo de pago</label>
                                    <div class="row g-2">
                                        <div class="col-4">
                                            <div class="payment-method" onclick="selectPayment('cash')">
                                                <i class="fas fa-money-bill-wave fa-2x mb-2 text-success"></i>
                                                <div class="small">Efectivo</div>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="payment-method" onclick="selectPayment('yappy')">
                                                <i class="fas fa-mobile-alt fa-2x mb-2 text-primary"></i>
                                                <div class="small">Yappy</div>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="payment-method" onclick="selectPayment('ach')">
                                                <i class="fas fa-university fa-2x mb-2 text-warning"></i>
                                                <div class="small">ACH Express</div>
                                            </div>
                                        </div>
                                    </div>
                                    <input type="hidden" id="orderPayment" value="cash">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-primary" onclick="createNewOrder()">
                                    Publicar Pedido
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contenido Principal -->
                <div class="container-fluid py-4">
                    <!-- Estad√≠sticas -->
                    <div class="row mb-4">
                        <div class="col-md-3 col-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-number" id="totalOrders">0</div>
                                <div class="stat-label">Pedidos Totales</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-number text-success" id="deliveredOrders">0</div>
                                <div class="stat-label">Entregados</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-number text-warning" id="pendingOrders">0</div>
                                <div class="stat-label">En Proceso</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-number text-primary" id="activeOrders">0</div>
                                <div class="stat-label">Activos</div>
                            </div>
                        </div>
                    </div>

                    <!-- Pedidos Activos -->
                    <div class="card-main mb-4">
                        <div class="card-body">
                            <h5 class="fw-bold mb-4">Pedidos Activos</h5>
                            <div id="activeOrdersList">
                                <div class="empty-state">
                                    <i class="fas fa-inbox"></i>
                                    <p>No tienes pedidos activos</p>
                                    <button class="btn btn-primary btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#newOrderModal">
                                        Crear mi primer pedido
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Inicializar mapa para nuevo pedido
            initNewOrderMap();
        }

        function renderRepartidorDashboard() {
            document.getElementById('app').innerHTML = `
                <!-- Navbar -->
                <nav class="navbar navbar-main navbar-expand-lg">
                    <div class="container-fluid">
                        <a class="navbar-brand" href="#">
                            <i class="fas fa-bolt me-2"></i>RapidSend
                            <span class="badge bg-primary ms-2">Repartidor</span>
                        </a>
                        
                        <div class="d-flex align-items-center gap-3">
                            <!-- Estado -->
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="onlineSwitch" checked 
                                       onchange="toggleOnlineStatus(this.checked)">
                                <label class="form-check-label" for="onlineSwitch" id="statusLabel">
                                    En l√≠nea
                                </label>
                            </div>
                            
                            <div class="dropdown">
                                <button class="btn btn-outline-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                                    <i class="fas fa-user me-1"></i> ${AppState.userData?.nombre || 'Repartidor'}
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="showProfile()">Mi Perfil</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="showEarnings()">Ganancias</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="logout()">Cerrar Sesi√≥n</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </nav>

                <!-- Contenido Principal -->
                <div class="container-fluid py-4">
                    <!-- Estad√≠sticas -->
                    <div class="row mb-4">
                        <div class="col-md-3 col-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-number text-success" id="todayEarnings">$0</div>
                                <div class="stat-label">Ganancias Hoy</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-number" id="todayDeliveries">0</div>
                                <div class="stat-label">Entregas Hoy</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-number text-warning" id="myRating">5.0</div>
                                <div class="stat-label">Rating</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-number text-info" id="availableOrders">0</div>
                                <div class="stat-label">Pedidos Disponibles</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Pedidos Disponibles -->
                        <div class="col-lg-8 mb-4">
                            <div class="card-main">
                                <div class="card-body">
                                    <h5 class="fw-bold mb-4">Pedidos Disponibles</h5>
                                    <div id="availableOrdersList">
                                        <div class="empty-state">
                                            <i class="fas fa-search"></i>
                                            <p>No hay pedidos disponibles</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Mis Pedidos -->
                        <div class="col-lg-4 mb-4">
                            <div class="card-main">
                                <div class="card-body">
                                    <h5 class="fw-bold mb-4">Mis Pedidos</h5>
                                    <div id="myOrdersList">
                                        <div class="empty-state">
                                            <i class="fas fa-box"></i>
                                            <p>No tienes pedidos activos</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Mapa -->
                    <div class="card-main">
                        <div class="card-body">
                            <h5 class="fw-bold mb-4">Mi Ubicaci√≥n</h5>
                            <div class="map-container">
                                <div id="repartidorMap"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Inicializar mapa para repartidor
            initRepartidorMap();
            loadAvailableOrders();
            loadMyOrders();
        }

        // ====================
        // FUNCIONALIDADES
        // ====================
        function initNewOrderMap() {
            setTimeout(() => {
                const map = initMap('newOrderMap', {
                    onClick: function(latlng, map) {
                        if (!window.selectedOrigin) {
                            // Seleccionar origen
                            window.selectedOrigin = latlng;
                            document.getElementById('orderOrigen').value = `Lat: ${latlng.lat.toFixed(4)}, Lng: ${latlng.lng.toFixed(4)}`;
                            document.getElementById('orderOrigenLat').value = latlng.lat;
                            document.getElementById('orderOrigenLng').value = latlng.lng;
                            
                            addMarker(latlng.lat, latlng.lng, 'Origen', 'green');
                            
                            Swal.fire('Origen seleccionado', 'Ahora selecciona el destino', 'info');
                            
                        } else if (!window.selectedDest) {
                            // Seleccionar destino
                            window.selectedDest = latlng;
                            document.getElementById('orderDestino').value = `Lat: ${latlng.lat.toFixed(4)}, Lng: ${latlng.lng.toFixed(4)}`;
                            document.getElementById('orderDestinoLat').value = latlng.lat;
                            document.getElementById('orderDestinoLng').value = latlng.lng;
                            
                            addMarker(latlng.lat, latlng.lng, 'Destino', 'red');
                            
                            // Dibujar ruta
                            calculateRoute(
                                window.selectedOrigin.lat,
                                window.selectedOrigin.lng,
                                latlng.lat,
                                latlng.lng
                            );
                            
                            Swal.fire('Destino seleccionado', 'Ambas ubicaciones configuradas', 'success');
                            
                        } else {
                            // Preguntar cu√°l reemplazar
                            Swal.fire({
                                title: '¬øQu√© ubicaci√≥n quieres cambiar?',
                                showCancelButton: true,
                                confirmButtonText: 'Origen',
                                cancelButtonText: 'Destino'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    window.selectedOrigin = latlng;
                                    document.getElementById('orderOrigen').value = `Lat: ${latlng.lat.toFixed(4)}, Lng: ${latlng.lng.toFixed(4)}`;
                                    document.getElementById('orderOrigenLat').value = latlng.lat;
                                    document.getElementById('orderOrigenLng').value = latlng.lng;
                                } else {
                                    window.selectedDest = latlng;
                                    document.getElementById('orderDestino').value = `Lat: ${latlng.lat.toFixed(4)}, Lng: ${latlng.lng.toFixed(4)}`;
                                    document.getElementById('orderDestinoLat').value = latlng.lat;
                                    document.getElementById('orderDestinoLng').value = latlng.lng;
                                }
                            });
                        }
                    }
                });
            }, 500);
        }

        function initRepartidorMap() {
            setTimeout(() => {
                initMap('repartidorMap');
            }, 500);
        }

        function selectUrgency(level) {
            document.getElementById('orderUrgency').value = level;
        }

        function selectPayment(method) {
            document.getElementById('orderPayment').value = method;
            
            // Actualizar selecci√≥n visual
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('selected');
            });
            event.target.closest('.payment-method').classList.add('selected');
        }

        async function createNewOrder() {
            const origen = document.getElementById('orderOrigen').value;
            const destino = document.getElementById('orderDestino').value;
            const origenLat = document.getElementById('orderOrigenLat').value;
            const origenLng = document.getElementById('orderOrigenLng').value;
            const destinoLat = document.getElementById('orderDestinoLat').value;
            const destinoLng = document.getElementById('orderDestinoLng').value;
            const descripcion = document.getElementById('orderDescripcion').value;
            const urgencia = document.getElementById('orderUrgency').value;
            const precio = document.getElementById('orderPrecio').value;
            const pago = document.getElementById('orderPayment').value;
            
            if (!origen || !destino) {
                Swal.fire('Error', 'Selecciona origen y destino en el mapa', 'error');
                return;
            }
            
            if (!descripcion) {
                Swal.fire('Error', 'Describe qu√© vas a enviar', 'error');
                return;
            }
            
            try {
                const orderId = await createOrder({
                    origen: origen,
                    destino: destino,
                    origenLat: parseFloat(origenLat),
                    origenLng: parseFloat(origenLng),
                    destinoLat: parseFloat(destinoLat),
                    destinoLng: parseFloat(destinoLng),
                    descripcion: descripcion,
                    urgencia: urgencia,
                    precio: parseFloat(precio),
                    metodoPago: pago
                });
                
                // Cerrar modal y limpiar
                bootstrap.Modal.getInstance(document.getElementById('newOrderModal')).hide();
                
                Swal.fire({
                    title: '‚úÖ Pedido publicado',
                    html: `Tu pedido ha sido publicado. Los repartidores han sido notificados.`,
                    icon: 'success'
                }).then(() => {
                    loadActiveOrders();
                });
                
            } catch (error) {
                Swal.fire('Error', 'No se pudo crear el pedido', 'error');
            }
        }

        async function toggleOnlineStatus(isOnline) {
            const label = document.getElementById('statusLabel');
            
            if (isOnline) {
                label.textContent = 'En l√≠nea';
                label.className = 'form-check-label text-success';
                
                // Actualizar en Firestore
                await db.collection('usuarios').doc(AppState.currentUser.uid).update({
                    activo: true,
                    lastActive: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Cargar pedidos disponibles
                loadAvailableOrders();
                
            } else {
                label.textContent = 'Desconectado';
                label.className = 'form-check-label text-danger';
                
                await db.collection('usuarios').doc(AppState.currentUser.uid).update({
                    activo: false
                });
            }
        }

        async function loadDashboardData() {
            if (AppState.userRole === 'cliente') {
                loadActiveOrders();
                loadStats();
            } else {
                loadAvailableOrders();
                loadMyOrders();
                loadRepartidorStats();
            }
        }

        async function loadActiveOrders() {
            try {
                const snapshot = await db.collection('pedidos')
                    .where('clienteId', '==', AppState.currentUser.uid)
                    .where('status', 'in', ['pending', 'accepted', 'picked'])
                    .orderBy('createdAt', 'desc')
                    .limit(20)
                    .get();
                
                const orders = [];
                snapshot.forEach(doc => {
                    orders.push({ id: doc.id, ...doc.data() });
                });
                
                renderActiveOrders(orders);
                
            } catch (error) {
                console.error('Error cargando pedidos:', error);
            }
        }

        function renderActiveOrders(orders) {
            const container = document.getElementById('activeOrdersList');
            if (!container) return;
            
            if (orders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>No tienes pedidos activos</p>
                        <button class="btn btn-primary btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#newOrderModal">
                            Crear mi primer pedido
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = orders.map(order => `
                <div class="order-card ${order.urgencia || 'standard'} mb-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <h6 class="fw-bold mb-1">${order.descripcion}</h6>
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <span class="status-badge status-${order.status}">
                                    ${order.status === 'pending' ? 'Pendiente' : 
                                      order.status === 'accepted' ? 'Aceptado' : 'Recogido'}
                                </span>
                                <span class="badge ${order.urgencia === 'urgent' ? 'badge-urgent' : 
                                                   order.urgencia === 'express' ? 'badge-express' : 'badge-standard'}">
                                    ${order.urgencia === 'urgent' ? 'URGENTE' : 
                                     order.urgencia === 'express' ? 'EXPRESS' : 'EST√ÅNDAR'}
                                </span>
                            </div>
                            <p class="small text-muted mb-1">
                                <i class="fas fa-map-marker-alt me-1"></i>
                                ${order.origen.substring(0, 50)}...
                            </p>
                            <p class="small text-muted">
                                <i class="fas fa-flag-checkered me-1"></i>
                                ${order.destino.substring(0, 50)}...
                            </p>
                        </div>
                        <div class="text-end">
                            <div class="h5 fw-bold text-primary">$${order.precio}</div>
                            <small class="text-muted">${order.createdAt ? new Date(order.createdAt.toDate()).toLocaleDateString() : ''}</small>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            ${order.repartidorNombre ? `
                                <small class="d-block">Repartidor:</small>
                                <strong>${order.repartidorNombre}</strong>
                            ` : `
                                <small class="text-muted">Buscando repartidor...</small>
                            `}
                        </div>
                        
                        <div class="d-flex gap-2">
                            ${order.repartidorTelefono ? `
                                <a href="https://wa.me/507${order.repartidorTelefono.replace(/\D/g, '')}" 
                                   target="_blank" 
                                   class="whatsapp-btn btn-sm">
                                    <i class="fab fa-whatsapp"></i> Contactar
                                </a>
                            ` : ''}
                            
                            <button class="btn btn-outline-primary btn-sm" onclick="openChat('${order.id}')">
                                <i class="fas fa-comment"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function loadAvailableOrders() {
            try {
                const snapshot = await db.collection('pedidos')
                    .where('status', '==', 'pending')
                    .orderBy('createdAt', 'desc')
                    .limit(20)
                    .get();
                
                const orders = [];
                snapshot.forEach(doc => {
                    orders.push({ id: doc.id, ...doc.data() });
                });
                
                renderAvailableOrders(orders);
                
            } catch (error) {
                console.error('Error cargando pedidos disponibles:', error);
            }
        }

        function renderAvailableOrders(orders) {
            const container = document.getElementById('availableOrdersList');
            if (!container) return;
            
            if (orders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <p>No hay pedidos disponibles</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = orders.map(order => `
                <div class="order-card ${order.urgencia || 'standard'} mb-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <h6 class="fw-bold mb-1">${order.descripcion}</h6>
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <span class="status-badge status-pending">Pendiente</span>
                                <span class="badge ${order.urgencia === 'urgent' ? 'badge-urgent' : 
                                                   order.urgencia === 'express' ? 'badge-express' : 'badge-standard'}">
                                    ${order.urgencia === 'urgent' ? 'URGENTE' : 
                                     order.urgencia === 'express' ? 'EXPRESS' : 'EST√ÅNDAR'}
                                </span>
                            </div>
                            <p class="small text-muted mb-1">
                                <i class="fas fa-map-marker-alt me-1"></i>
                                ${order.origen.substring(0, 50)}...
                            </p>
                            <p class="small text-muted">
                                <i class="fas fa-flag-checkered me-1"></i>
                                ${order.destino.substring(0, 50)}...
                            </p>
                            <small class="d-block mt-1">
                                <i class="fas fa-user me-1"></i> ${order.clienteNombre}
                            </small>
                        </div>
                        <div class="text-end">
                            <div class="h5 fw-bold text-primary">$${order.precio}</div>
                            <small class="text-muted">${order.createdAt ? new Date(order.createdAt.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : ''}</small>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">Distancia: ~5 km</small>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <a href="https://wa.me/507${order.clienteTelefono.replace(/\D/g, '')}" 
                               target="_blank" 
                               class="whatsapp-btn btn-sm">
                                <i class="fab fa-whatsapp"></i>
                            </a>
                            
                            <button class="btn btn-primary btn-sm" onclick="acceptOrderPrompt('${order.id}')">
                                <i class="fas fa-check me-1"></i>Aceptar
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Actualizar contador
            const counter = document.getElementById('availableOrders');
            if (counter) {
                counter.textContent = orders.length;
            }
        }

        async function acceptOrderPrompt(orderId) {
            const result = await Swal.fire({
                title: '¬øAceptar este pedido?',
                text: 'Al aceptar, ser√°s asignado como el repartidor responsable',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'S√≠, aceptar',
                cancelButtonText: 'Cancelar'
            });
            
            if (result.isConfirmed) {
                try {
                    await acceptOrder(orderId);
                    Swal.fire('‚úÖ Pedido aceptado', 'El cliente ha sido notificado', 'success');
                    loadAvailableOrders();
                    loadMyOrders();
                } catch (error) {
                    Swal.fire('Error', 'No se pudo aceptar el pedido', 'error');
                }
            }
        }

        async function loadMyOrders() {
            try {
                const snapshot = await db.collection('pedidos')
                    .where('repartidorId', '==', AppState.currentUser.uid)
                    .where('status', 'in', ['accepted', 'picked'])
                    .orderBy('createdAt', 'desc')
                    .limit(10)
                    .get();
                
                const orders = [];
                snapshot.forEach(doc => {
                    orders.push({ id: doc.id, ...doc.data() });
                });
                
                renderMyOrders(orders);
                
            } catch (error) {
                console.error('Error cargando mis pedidos:', error);
            }
        }

        function renderMyOrders(orders) {
            const container = document.getElementById('myOrdersList');
            if (!container) return;
            
            if (orders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-box"></i>
                        <p>No tienes pedidos activos</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = orders.map(order => `
                <div class="order-card ${order.urgencia || 'standard'} mb-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <h6 class="fw-bold mb-1">${order.descripcion}</h6>
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <span class="status-badge status-${order.status}">
                                    ${order.status === 'accepted' ? 'Aceptado' : 'Recogido'}
                                </span>
                            </div>
                            <p class="small text-muted">
                                <i class="fas fa-user me-1"></i> ${order.clienteNombre}
                            </p>
                        </div>
                        <div class="text-end">
                            <div class="h5 fw-bold text-primary">$${order.precio}</div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <a href="https://wa.me/507${order.clienteTelefono.replace(/\D/g, '')}" 
                               target="_blank" 
                               class="whatsapp-btn btn-sm">
                                <i class="fab fa-whatsapp"></i> Contactar
                            </a>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary btn-sm" onclick="openChat('${order.id}')">
                                <i class="fas fa-comment"></i>
                            </button>
                            
                            ${order.status === 'accepted' ? `
                                <button class="btn btn-success btn-sm" onclick="updateOrderStatus('${order.id}', 'picked')">
                                    <i class="fas fa-box"></i> Recogido
                                </button>
                            ` : `
                                <button class="btn btn-success btn-sm" onclick="updateOrderStatus('${order.id}', 'delivered')">
                                    <i class="fas fa-check"></i> Entregado
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function updateOrderStatus(orderId, status) {
            try {
                await updateOrderStatus(orderId, status);
                Swal.fire('‚úÖ Estado actualizado', 'El cambio ha sido registrado', 'success');
                loadMyOrders();
                if (AppState.userRole === 'cliente') {
                    loadActiveOrders();
                }
            } catch (error) {
                Swal.fire('Error', 'No se pudo actualizar el estado', 'error');
            }
        }

        async function loadStats() {
            // Cargar estad√≠sticas del cliente
            try {
                const snapshot = await db.collection('pedidos')
                    .where('clienteId', '==', AppState.currentUser.uid)
                    .get();
                
                const total = snapshot.size;
                const delivered = snapshot.docs.filter(doc => doc.data().status === 'delivered').length;
                const pending = snapshot.docs.filter(doc => ['pending', 'accepted', 'picked'].includes(doc.data().status)).length;
                const active = snapshot.docs.filter(doc => ['accepted', 'picked'].includes(doc.data().status)).length;
                
                // Actualizar UI
                document.getElementById('totalOrders')?.textContent = total;
                document.getElementById('deliveredOrders')?.textContent = delivered;
                document.getElementById('pendingOrders')?.textContent = pending;
                document.getElementById('activeOrders')?.textContent = active;
                
            } catch (error) {
                console.error('Error cargando estad√≠sticas:', error);
            }
        }

        async function loadRepartidorStats() {
            // Estad√≠sticas de repartidor
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            try {
                const snapshot = await db.collection('pedidos')
                    .where('repartidorId', '==', AppState.currentUser.uid)
                    .where('deliveredAt', '>=', today)
                    .get();
                
                const todayDeliveries = snapshot.size;
                const todayEarnings = snapshot.docs.reduce((sum, doc) => sum + (doc.data().precio || 0), 0);
                
                document.getElementById('todayDeliveries')?.textContent = todayDeliveries;
                document.getElementById('todayEarnings')?.textContent = `$${todayEarnings.toFixed(2)}`;
                
            } catch (error) {
                console.error('Error cargando estad√≠sticas repartidor:', error);
            }
        }

        async function showProfile() {
            const user = AppState.userData;
            
            Swal.fire({
                title: 'Mi Perfil',
                html: `
                    <div class="text-center">
                        <div class="profile-pic mx-auto mb-3" style="background: #4361ee; color: white; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-user fa-3x"></i>
                        </div>
                        
                        <h5 class="fw-bold">${user?.nombre || 'Usuario'}</h5>
                        <p class="text-muted">${user?.email || ''}</p>
                        
                        <div class="text-start mt-4">
                            <p><strong>üì± WhatsApp:</strong> ${user?.telefono || 'No registrado'}</p>
                            <p><strong>üè∑Ô∏è Rol:</strong> ${user?.rol === 'cliente' ? 'Cliente' : 'Repartidor'}</p>
                            ${user?.rol === 'repartidor' ? `
                                <p><strong>üü¢ Estado:</strong> ${user?.activo ? 'En l√≠nea' : 'Desconectado'}</p>
                            ` : ''}
                        </div>
                        
                        <div class="d-grid gap-2 mt-4">
                            <button class="btn btn-primary" onclick="editProfile()">
                                <i class="fas fa-edit me-2"></i>Editar Perfil
                            </button>
                        </div>
                    </div>
                `,
                showConfirmButton: false,
                showCloseButton: true
            });
        }

        async function editProfile() {
            const user = AppState.userData;
            
            const { value: formValues } = await Swal.fire({
                title: 'Editar Perfil',
                html: `
                    <div class="text-start">
                        <div class="mb-3">
                            <label class="form-label">Nombre completo</label>
                            <input type="text" id="editName" class="form-control" value="${user?.nombre || ''}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">WhatsApp</label>
                            <div class="input-group">
                                <span class="input-group-text">+507</span>
                                <input type="tel" id="editPhone" class="form-control" value="${user?.telefono?.replace('+507', '') || ''}">
                            </div>
                        </div>
                    </div>
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Guardar',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    return {
                        name: document.getElementById('editName').value,
                        phone: document.getElementById('editPhone').value
                    };
                }
            });
            
            if (formValues) {
                try {
                    await db.collection('usuarios').doc(AppState.currentUser.uid).update({
                        nombre: formValues.name,
                        telefono: `+507${formValues.phone.replace(/\D/g, '')}`
                    });
                    
                    // Actualizar estado local
                    AppState.userData.nombre = formValues.name;
                    AppState.userData.telefono = `+507${formValues.phone.replace(/\D/g, '')}`;
                    
                    Swal.fire('‚úÖ Perfil actualizado', 'Los cambios han sido guardados', 'success');
                    
                } catch (error) {
                    Swal.fire('Error', 'No se pudo actualizar el perfil', 'error');
                }
            }
        }

        async function showHistory() {
            Swal.fire('En desarrollo', 'Esta funci√≥n estar√° disponible pronto', 'info');
        }

        async function showEarnings() {
            Swal.fire('En desarrollo', 'Esta funci√≥n estar√° disponible pronto', 'info');
        }

        async function logout() {
            const result = await Swal.fire({
                title: '¬øCerrar sesi√≥n?',
                text: 'Se terminar√° tu sesi√≥n actual',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'S√≠, cerrar sesi√≥n',
                cancelButtonText: 'Cancelar'
            });
            
            if (result.isConfirmed) {
                await auth.signOut();
                
                // Limpiar estado
                AppState.currentUser = null;
                AppState.userRole = null;
                AppState.userData = null;
                localStorage.removeItem('rapidsend_user');
                
                // Detener listeners
                if (AppState.listeners.chat) {
                    AppState.listeners.chat();
                }
                
                renderLogin();
            }
        }

        // ====================
        // INICIALIZACI√ìN
        // ====================
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar autenticaci√≥n
            auth.onAuthStateChanged(async (user) => {
                AppState.currentUser = user;
                
                if (user) {
                    // Cargar datos del usuario
                    await loadUserData(user.uid);
                    
                    // Renderizar dashboard
                    renderDashboard();
                    
                } else {
                    // Verificar localStorage
                    const savedUser = localStorage.getItem('rapidsend_user');
                    if (savedUser) {
                        const userData = JSON.parse(savedUser);
                        AppState.currentUser = { uid: userData.uid };
                        AppState.userRole = userData.role;
                        AppState.userData = userData.data;
                        renderDashboard();
                    } else {
                        renderLogin();
                    }
                }
            });
        });
    </script>
</body>
</html>
