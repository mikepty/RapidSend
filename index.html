<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RapidSend</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"/>
    <style>
        :root{--red:#dc143c;--dark:#1a1a1a;--white:#fff}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',sans-serif;background:#f5f5f5;color:var(--dark)}
        .navbar-main{background:linear-gradient(135deg,var(--red),#8b0000)!important;box-shadow:0 4px 20px rgba(220,20,60,.4);padding:1rem 0}
        .navbar-brand{font-size:1.8rem;font-weight:800}
        .sidebar{background:var(--white);border-radius:15px;box-shadow:0 5px 20px rgba(0,0,0,.1)}
        .sidebar-header{background:linear-gradient(135deg,var(--dark),#333);color:var(--white);padding:1.5rem;text-align:center}
        .user-avatar{width:80px;height:80px;border-radius:50%;background:var(--red);color:var(--white);display:flex;align-items:center;justify-content:center;font-size:2rem;margin:0 auto 1rem;border:4px solid var(--white)}
        .list-group-item{border:none;border-left:4px solid transparent;transition:all .3s}
        .list-group-item:hover{background:#f5f5f5;border-left-color:var(--red);transform:translateX(5px)}
        .card-main{background:var(--white);border-radius:15px;box-shadow:0 5px 20px rgba(0,0,0,.08);border-top:5px solid var(--red)}
        .order-card{background:var(--white);border-left:5px solid var(--red);border-radius:12px;padding:1.5rem;margin-bottom:1.5rem;transition:all .3s}
        .order-card:hover{transform:translateX(8px);box-shadow:0 8px 25px rgba(0,0,0,.12)}
        .order-card.urgent{border-left-color:#8b0000;background:linear-gradient(to right,rgba(220,20,60,.08),var(--white));animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(220,20,60,.4)}50%{box-shadow:0 0 0 10px rgba(220,20,60,0)}}
        .btn-primary{background:linear-gradient(135deg,var(--red),#8b0000);border:none;font-weight:700;padding:.75rem 2rem;border-radius:30px}
        .btn-primary:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(220,20,60,.4)}
        .btn-whatsapp{background:#25D366;color:var(--white);border:none;font-weight:600;border-radius:30px}
        #map,#trackMap,.map{height:500px;border-radius:15px;border:3px solid var(--red);box-shadow:0 5px 20px rgba(0,0,0,.1)}
        .badge-custom{padding:.5rem 1rem;border-radius:20px;font-weight:700}
        .cert-badge{background:linear-gradient(135deg,#FFD700,#FFA500);color:var(--dark);padding:1rem;border-radius:10px;font-weight:700}
        @media(max-width:768px){#map,#trackMap,.map{height:350px}.navbar-brand{font-size:1.3rem}.user-avatar{width:60px;height:60px}}
    </style>
</head>
<body>
    <div id="app">
        <div style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--red),#8b0000)">
            <div style="background:white;padding:40px;border-radius:20px;text-align:center">
                <h1 style="color:var(--red)">RapidSend</h1>
                <div style="margin:20px auto;width:50px;height:50px;border:4px solid #f3f3f3;border-top:4px solid var(--red);border-radius:50%;animation:spin 1s linear infinite"></div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <style>@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}</style>
    <script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import{getAuth,createUserWithEmailAndPassword,signInWithEmailAndPassword,signOut,onAuthStateChanged,updateProfile,GoogleAuthProvider,signInWithPopup}from"https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import{getFirestore,collection,addDoc,getDocs,doc,getDoc,setDoc,updateDoc,query,where,orderBy,serverTimestamp,onSnapshot}from"https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
const app=initializeApp({apiKey:"AIzaSyDxD4g_uYEUKB37uNHvDWus_NQHoSAMK_8",authDomain:"rapidsend-1f640.firebaseapp.com",projectId:"rapidsend-1f640",storageBucket:"rapidsend-1f640.firebasestorage.app",messagingSenderId:"249514582496",appId:"1:249514582496:web:cafcc8760282983f24cb85"});
const auth=getAuth(app),db=getFirestore(app),gp=new GoogleAuthProvider();
window.fb={app,auth,db,gp,fs:{collection,addDoc,getDocs,doc,getDoc,setDoc,updateDoc,query,where,orderBy,serverTimestamp,onSnapshot},am:{createUserWithEmailAndPassword,signInWithEmailAndPassword,signOut,onAuthStateChanged,updateProfile,signInWithPopup}};
window.S={u:null,d:null,r:null,o:null,dest:null,map:null};
onAuthStateChanged(auth,async u=>{S.u=u;if(u){const d=await getDoc(doc(db,'usuarios',u.uid));if(d.exists()){S.d=d.data();S.r=d.data().rol}else{await setDoc(doc(db,'usuarios',u.uid),{nombre:u.displayName||'Usuario',email:u.email,rol:'cliente',telefono:'',fechaRegistro:serverTimestamp(),activo:false,calificacion:5,entregasCompletadas:0,certificadoMedico:false});S.d={nombre:u.displayName,email:u.email,rol:'cliente',certificadoMedico:false};S.r='cliente'}renderMain()}else renderLogin()});

window.renderLogin=()=>document.getElementById('app').innerHTML=`<div style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--red),#8b0000);padding:20px"><div style="background:white;padding:40px;border-radius:20px;max-width:500px;width:100%"><h1 style="color:var(--red);text-align:center">RapidSend</h1><div class="mb-3"><input type="email"class="form-control"id="le"placeholder="Email"></div><div class="mb-3"><input type="password"class="form-control"id="lp"placeholder="Contrase√±a"></div><button onclick="login()"class="btn btn-primary w-100 mb-3">Ingresar</button><button onclick="gLogin()"class="btn btn-outline-dark w-100 mb-3">Google</button><hr><div class="mb-3"><input type="text"class="form-control"id="rn"placeholder="Nombre"></div><div class="mb-3"><input type="email"class="form-control"id="re"placeholder="Email"></div><div class="mb-3"><input type="password"class="form-control"id="rp"placeholder="Contrase√±a"></div><div class="mb-3"><input type="tel"class="form-control"id="rt"placeholder="Tel√©fono"></div><div class="mb-3"><select class="form-select"id="rr"><option value="cliente">Cliente</option><option value="repartidor">Repartidor</option><option value="institucion">Instituci√≥n</option></select></div><button onclick="register()"class="btn btn-dark w-100">Registrar</button></div></div>`;

window.login=async()=>{const e=document.getElementById('le').value,p=document.getElementById('lp').value;if(!e||!p)return Swal.fire('Error','Completa campos','error');try{await signInWithEmailAndPassword(auth,e,p);Swal.fire({icon:'success',title:'Bienvenido',timer:1500,showConfirmButton:false})}catch(er){Swal.fire('Error','Credenciales incorrectas','error')}};

window.register=async()=>{const n=document.getElementById('rn').value,e=document.getElementById('re').value,p=document.getElementById('rp').value,t=document.getElementById('rt').value,r=document.getElementById('rr').value;if(!n||!e||!p)return Swal.fire('Error','Completa campos','error');try{const res=await createUserWithEmailAndPassword(auth,e,p);await updateProfile(res.user,{displayName:n});await setDoc(doc(db,'usuarios',res.user.uid),{nombre:n,email:e,rol:r,telefono:t,fechaRegistro:serverTimestamp(),activo:false,calificacion:5,entregasCompletadas:0,certificadoMedico:false});Swal.fire({icon:'success',title:'Cuenta creada',timer:2000,showConfirmButton:false})}catch(er){Swal.fire('Error',er.message,'error')}};

window.gLogin=async()=>{try{const res=await signInWithPopup(auth,gp),ud=await getDoc(doc(db,'usuarios',res.user.uid));if(!ud.exists()){const{value:r}=await Swal.fire({title:'Rol',input:'select',inputOptions:{cliente:'Cliente',repartidor:'Repartidor',institucion:'Instituci√≥n'},showCancelButton:false});await setDoc(doc(db,'usuarios',res.user.uid),{nombre:res.user.displayName,email:res.user.email,rol:r,telefono:'',fechaRegistro:serverTimestamp(),activo:false,calificacion:5,entregasCompletadas:0,certificadoMedico:false})}}catch(er){if(er.code!=='auth/popup-closed-by-user')Swal.fire('Error',er.message,'error')}};
    </script>
    <script>
window.renderMain=()=>{const r=S.r,rt=r==='repartidor'?'Repartidor':r==='institucion'?'Instituci√≥n':'Cliente';document.getElementById('app').innerHTML=`<nav class="navbar navbar-main"><div class="container-fluid"><a class="navbar-brand text-white"href="#"onclick="home()"><i class="fas fa-bolt me-2"></i>RapidSend <span class="badge bg-light text-dark">${rt}</span></a><button class="btn btn-light btn-sm"onclick="signOut(fb.auth)"><i class="fas fa-sign-out-alt"></i></button></div></nav><div class="container py-4"><div class="row"><div class="col-md-3 mb-4"><div class="sidebar"><div class="sidebar-header"><div class="user-avatar">${S.d?.nombre?.charAt(0)||'U'}</div><h6>${S.d?.nombre||'Usuario'}</h6><small>${S.d?.email||''}</small></div><div class="list-group list-group-flush"><button class="list-group-item list-group-item-action"onclick="home()"><i class="fas fa-home me-2"></i>Inicio</button>${r==='cliente'||r==='institucion'?`<button class="list-group-item list-group-item-action"onclick="newOrder()"><i class="fas fa-plus me-2"></i>Nuevo</button><button class="list-group-item list-group-item-action"onclick="myOrders()"><i class="fas fa-list me-2"></i>Pedidos</button>`:''} ${r==='repartidor'?`<button class="list-group-item list-group-item-action"onclick="availOrders()"><i class="fas fa-search me-2"></i>Disponibles</button><button class="list-group-item list-group-item-action"onclick="myDelivs()"><i class="fas fa-motorcycle me-2"></i>Entregas</button><button class="list-group-item list-group-item-action"onclick="toggleOnline()"><i class="fas fa-toggle-on me-2"></i>${S.d?.activo?'Offline':'Online'}</button><button class="list-group-item list-group-item-action"onclick="certify()"><i class="fas fa-certificate me-2"></i>Certificaci√≥n</button>`:''}<button class="list-group-item list-group-item-action"onclick="editProf()"><i class="fas fa-user-edit me-2"></i>Perfil</button></div></div></div><div class="col-md-9"><div id="content"></div></div></div></div>`;home()};

window.home=()=>document.getElementById('content').innerHTML=`<div class="card-main p-4"><h2>Bienvenido, ${S.d?.nombre}</h2><div class="row mt-4">${S.r==='cliente'||S.r==='institucion'?`<div class="col-md-6 mb-3"><div class="card text-center p-4"><i class="fas fa-box fa-3x text-danger mb-3"></i><h5>Crear Pedido</h5><button class="btn btn-primary mt-2"onclick="newOrder()">Nuevo</button></div></div>`:''} ${S.r==='repartidor'?`<div class="col-md-6 mb-3"><div class="card text-center p-4"><i class="fas fa-search fa-3x text-danger mb-3"></i><h5>Buscar</h5><button class="btn btn-primary mt-2"onclick="availOrders()">Ver</button></div></div>${S.d?.certificadoMedico?'<div class="col-12"><div class="cert-badge"><i class="fas fa-check-circle me-2"></i>Certificado M√©dico Activo</div></div>':''}`:''}</div></div>`;

window.editProf=async()=>{const{value:v}=await Swal.fire({title:'Editar Perfil',html:`<input class="form-control mb-3"id="pn"value="${S.d?.nombre||''}"placeholder="Nombre"><input class="form-control mb-3"id="pt"value="${S.d?.telefono||''}"placeholder="Tel√©fono">`,showCancelButton:true,confirmButtonText:'Guardar',preConfirm:()=>({nombre:document.getElementById('pn').value,telefono:document.getElementById('pt').value})});if(v){await fb.fs.updateDoc(fb.fs.doc(fb.db,'usuarios',S.u.uid),v);S.d={...S.d,...v};Swal.fire('Guardado','Perfil actualizado','success');renderMain()}};

window.certify=async()=>{const{isConfirmed}=await Swal.fire({title:'Certificaci√≥n M√©dica',html:'<p>Para transportar insumos m√©dicos necesitas certificaci√≥n.</p><p>¬øDeseas solicitar certificaci√≥n?</p>',icon:'info',showCancelButton:true,confirmButtonText:'Solicitar'});if(isConfirmed){await fb.fs.updateDoc(fb.fs.doc(fb.db,'usuarios',S.u.uid),{certificadoMedico:true});S.d.certificadoMedico=true;Swal.fire('Aprobado','Certificaci√≥n activada','success');renderMain()}};

window.toggleOnline=async()=>{const ns=!S.d?.activo;await fb.fs.updateDoc(fb.fs.doc(fb.db,'usuarios',S.u.uid),{activo:ns});S.d.activo=ns;Swal.fire({icon:'success',title:ns?'En l√≠nea':'Offline',timer:1500,showConfirmButton:false});renderMain()};
    </script>
    <script>
window.newOrder=async()=>{S.o=null;S.dest=null;const{value:v}=await Swal.fire({title:'Nuevo Pedido',html:`<div class="text-start"><input class="form-control mb-2"id="od"placeholder="Descripci√≥n"><select class="form-select mb-2"id="ot"><option value="normal">Normal</option><option value="medicamento">Medicamento</option><option value="insumo_medico">Insumo M√©dico</option></select><select class="form-select mb-2"id="ou"><option value="baja">Baja</option><option value="media">Media</option><option value="alta">Alta</option></select><div class="alert alert-info py-2 mb-2"><small>Click: origen(rojo), destino(verde)</small></div><div id="map"style="height:350px"></div><div class="row mb-2"><div class="col-6"><input class="form-control"id="of"placeholder="Origen"readonly></div><div class="col-6"><input class="form-control"id="ot2"placeholder="Destino"readonly></div></div><div class="row mb-2"><div class="col-6"><input class="form-control"id="op"value="10"type="number"min="5"></div><div class="col-6"><select class="form-select"id="ou2"><option value="standard">Normal</option><option value="express">Express</option><option value="urgent">Urgente</option></select></div></div><textarea class="form-control"id="oi"rows="2"placeholder="Instrucciones"></textarea></div>`,width:'90%',showCancelButton:true,didOpen:()=>{const m=L.map('map').setView([8.9833,-79.5167],13);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(m);let c=0,om=null,dm=null,rc=null;m.on('click',e=>{const co=[e.latlng.lat,e.latlng.lng],ad=`${co[0].toFixed(4)},${co[1].toFixed(4)}`;if(c===0){if(om)m.removeLayer(om);om=L.marker(co,{icon:L.divIcon({html:'<div style="background:#dc143c;width:30px;height:30px;border-radius:50%;border:3px solid white"></div>',iconSize:[30,30]})}).addTo(m);document.getElementById('of').value=ad;S.o={coords:co,address:ad};c=1}else if(c===1){if(dm)m.removeLayer(dm);dm=L.marker(co,{icon:L.divIcon({html:'<div style="background:#2ecc71;width:30px;height:30px;border-radius:50%;border:3px solid white"></div>',iconSize:[30,30]})}).addTo(m);document.getElementById('ot2').value=ad;S.dest={coords:co,address:ad};if(rc)m.removeControl(rc);rc=L.Routing.control({waypoints:[L.latLng(S.o.coords),L.latLng(co)],lineOptions:{styles:[{color:'#3498db',weight:4}]},createMarker:()=>null}).addTo(m);const R=6371,dLat=(co[0]-S.o.coords[0])*Math.PI/180,dLon=(co[1]-S.o.coords[1])*Math.PI/180,a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(S.o.coords[0]*Math.PI/180)*Math.cos(co[0]*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2),c2=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)),d=R*c2,p=Math.max(5,Math.round(d*2));document.getElementById('op').value=p;c=2}});if(navigator.geolocation)navigator.geolocation.getCurrentPosition(p=>m.setView([p.coords.latitude,p.coords.longitude],15))},preConfirm:()=>{const d=document.getElementById('od').value;if(!d||!S.o||!S.dest){Swal.showValidationMessage('Completa campos y mapa');return false}return{desc:d,from:S.o.address,to:S.dest.address,oc:S.o.coords,dc:S.dest.coords,price:document.getElementById('op').value,urg:document.getElementById('ou2').value,inst:document.getElementById('oi').value,tipo:document.getElementById('ot').value,niv:document.getElementById('ou').value}}});if(v){Swal.fire({title:'Creando...',allowOutsideClick:false,didOpen:()=>Swal.showLoading()});await fb.fs.addDoc(fb.fs.collection(fb.db,'pedidos'),{clienteId:S.u.uid,clienteNombre:S.d?.nombre,clienteTelefono:S.d?.telefono||'',clienteEmail:S.d?.email,descripcion:v.desc,origen:v.from,destino:v.to,origenCoords:{lat:v.oc[0],lng:v.oc[1]},destinoCoords:{lat:v.dc[0],lng:v.dc[1]},urgencia:v.urg,precio:parseFloat(v.price),instrucciones:v.inst,metodoPago:'efectivo',status:'pending',tipoPedido:v.tipo,nivelUrgencia:v.niv,precioInicial:parseFloat(v.price),precioFinal:null,estadoNegociacion:'abierta',creadoPorRol:S.r,institucionId:S.r==='institucion'?S.u.uid:null,repartidorId:null,repartidorNombre:null,repartidorTelefono:null,createdAt:fb.fs.serverTimestamp(),updatedAt:fb.fs.serverTimestamp()});Swal.fire({icon:'success',title:'Creado',timer:2000,showConfirmButton:false});myOrders()}};

window.myOrders=()=>{document.getElementById('content').innerHTML='<div class="card-main p-4"><h2>Mis Pedidos</h2><div id="ol">Cargando...</div></div>';const q=fb.fs.query(fb.fs.collection(fb.db,'pedidos'),fb.fs.where('clienteId','==',S.u.uid),fb.fs.orderBy('createdAt','desc'));fb.fs.onSnapshot(q,s=>{if(s.empty){document.getElementById('ol').innerHTML='<p class="text-center text-muted">Sin pedidos</p>'}else{let h='';s.forEach(d=>{const o=d.data(),id=d.id,st=o.status==='pending'?'warning':o.status==='delivered'?'success':'info',pr=o.precioFinal||o.precioInicial||o.precio;h+=`<div class="order-card ${o.nivelUrgencia==='alta'?'urgent':''}"><div class="d-flex justify-content-between mb-2"><div><h6>${o.descripcion}</h6><small>#${id.substring(0,8)}</small></div><span class="badge bg-${st}">${o.status}</span></div><small><i class="fas fa-map-marker-alt text-danger me-1"></i>${o.origen.substring(0,25)}</small><br><small><i class="fas fa-flag-checkered text-success me-1"></i>${o.destino.substring(0,25)}</small><div class="mt-2">${o.tipoPedido!=='normal'?`<span class="badge bg-info">${o.tipoPedido}</span> `:''}<span class="badge bg-dark">$${pr}</span></div>${o.repartidorId&&o.status!=='delivered'?`<button class="btn btn-sm btn-whatsapp w-100 mt-2"onclick="wa('${o.repartidorTelefono}','${id}')"><i class="fab fa-whatsapp me-1"></i>Repartidor</button>`:''} ${o.status==='pending'&&o.estadoNegociacion==='contraoferta'?`<button class="btn btn-sm btn-warning w-100 mt-2"onclick="viewOffers('${id}')">Ver Ofertas</button>`:''} ${o.repartidorId&&o.status!=='delivered'?`<button class="btn btn-sm btn-primary w-100 mt-2"onclick="trackOrder('${id}')"><i class="fas fa-map-marked-alt me-1"></i>Rastrear</button>`:''}</div>`;});document.getElementById('ol').innerHTML=h}})};

window.trackOrder=async id=>{const d=await fb.fs.getDoc(fb.fs.doc(fb.db,'pedidos',id));if(!d.exists())return;const o=d.data();Swal.fire({title:'Rastreando Pedido',html:`<div id="trackMap"style="height:400px"></div><div class="mt-3"><strong>Estado:</strong> ${o.status}<br><strong>Repartidor:</strong> ${o.repartidorNombre||'N/A'}</div>`,width:'90%',showConfirmButton:false,showCloseButton:true,didOpen:()=>{const m=L.map('trackMap').setView([o.origenCoords.lat,o.origenCoords.lng],13);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(m);L.marker([o.origenCoords.lat,o.origenCoords.lng],{icon:L.divIcon({html:'<div style="background:#dc143c;width:30px;height:30px;border-radius:50%"></div>'})}).addTo(m).bindPopup('Origen');L.marker([o.destinoCoords.lat,o.destinoCoords.lng],{icon:L.divIcon({html:'<div style="background:#2ecc71;width:30px;height:30px;border-radius:50%"></div>'})}).addTo(m).bindPopup('Destino');L.Routing.control({waypoints:[L.latLng(o.origenCoords.lat,o.origenCoords.lng),L.latLng(o.destinoCoords.lat,o.destinoCoords.lng)],lineOptions:{styles:[{color:'#3498db',weight:4}]},createMarker:()=>null}).addTo(m)}})};
    </script>
    <script>
window.availOrders=()=>{document.getElementById('content').innerHTML='<div class="card-main p-4"><h2>Disponibles</h2><div id="al">Cargando...</div></div>';const q=fb.fs.query(fb.fs.collection(fb.db,'pedidos'),fb.fs.where('status','==','pending'));fb.fs.onSnapshot(q,s=>{if(s.empty){document.getElementById('al').innerHTML='<p class="text-center text-muted">Sin pedidos</p>'}else{let h='';s.forEach(d=>{const o=d.data(),id=d.id,pi=o.precioInicial||o.precio,canAccept=o.tipoPedido==='insumo_medico'?S.d?.certificadoMedico:true;h+=`<div class="order-card ${o.nivelUrgencia==='alta'?'urgent':''}"><h6>${o.descripcion}</h6><small>Cliente: ${o.clienteNombre}</small><div class="mt-2"><small><i class="fas fa-map-marker-alt text-danger"></i> ${o.origen.substring(0,20)}</small><br><small><i class="fas fa-flag-checkered text-success"></i> ${o.destino.substring(0,20)}</small></div><div class="mt-2">${o.tipoPedido!=='normal'?`<span class="badge bg-info">${o.tipoPedido}</span> `:''}<span class="badge bg-dark">$${pi}</span></div><div class="btn-group w-100 mt-2">${canAccept?`<button class="btn btn-success btn-sm"onclick="acceptDirect('${id}')">Aceptar</button><button class="btn btn-warning btn-sm"onclick="sendOffer('${id}',${pi})">Ofertar</button>`:`<button class="btn btn-secondary btn-sm"disabled>Requiere Certificaci√≥n</button>`}</div><button class="btn btn-sm btn-primary w-100 mt-2"onclick="viewRoute('${id}')"><i class="fas fa-route me-1"></i>Ver Ruta</button></div>`;});document.getElementById('al').innerHTML=h}})};

window.viewRoute=async id=>{const d=await fb.fs.getDoc(fb.fs.doc(fb.db,'pedidos',id));if(!d.exists())return;const o=d.data();Swal.fire({title:'Ruta del Pedido',html:`<div id="routeMap"class="map"></div><div class="mt-3"><strong>Distancia estimada:</strong> <span id="dist">Calculando...</span><br><strong>Tiempo estimado:</strong> <span id="time">Calculando...</span></div>`,width:'90%',showCloseButton:true,didOpen:()=>{const m=L.map('routeMap').setView([o.origenCoords.lat,o.origenCoords.lng],13);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(m);L.marker([o.origenCoords.lat,o.origenCoords.lng],{icon:L.divIcon({html:'<div style="background:#dc143c;width:30px;height:30px;border-radius:50%"></div>'})}).addTo(m).bindPopup('Origen');L.marker([o.destinoCoords.lat,o.destinoCoords.lng],{icon:L.divIcon({html:'<div style="background:#2ecc71;width:30px;height:30px;border-radius:50%"></div>'})}).addTo(m).bindPopup('Destino');const rc=L.Routing.control({waypoints:[L.latLng(o.origenCoords.lat,o.origenCoords.lng),L.latLng(o.destinoCoords.lat,o.destinoCoords.lng)],lineOptions:{styles:[{color:'#dc143c',weight:5}]},createMarker:()=>null}).addTo(m);rc.on('routesfound',e=>{const r=e.routes[0];document.getElementById('dist').textContent=`${(r.summary.totalDistance/1000).toFixed(2)} km`;document.getElementById('time').textContent=`${Math.round(r.summary.totalTime/60)} min`})}})};

window.myDelivs=()=>{document.getElementById('content').innerHTML='<div class="card-main p-4"><h2>Entregas</h2><div id="dl">Cargando...</div></div>';const q=fb.fs.query(fb.fs.collection(fb.db,'pedidos'),fb.fs.where('repartidorId','==',S.u.uid));fb.fs.onSnapshot(q,s=>{if(s.empty){document.getElementById('dl').innerHTML='<p class="text-center text-muted">Sin entregas</p>'}else{let h='';s.forEach(d=>{const o=d.data(),id=d.id,pf=o.precioFinal||o.precioInicial||o.precio;h+=`<div class="order-card"><h6>${o.descripcion}</h6><small>Cliente: ${o.clienteNombre}</small><div class="mt-2"><small><i class="fas fa-map-marker-alt text-danger"></i> ${o.origen.substring(0,20)}</small><br><small><i class="fas fa-flag-checkered text-success"></i> ${o.destino.substring(0,20)}</small></div><div class="mt-2"><span class="badge bg-dark">$${pf}</span></div><div class="btn-group-vertical w-100 gap-2 mt-2">${o.status==='accepted'?`<button class="btn btn-primary btn-sm"onclick="updateSt('${id}','picked')">Recogido</button>`:''}${o.status==='picked'?`<button class="btn btn-success btn-sm"onclick="updateSt('${id}','delivered')">Entregado</button>`:''}${o.destinoCoords?`<div class="btn-group"><button class="btn btn-info btn-sm"onclick="openWaze(${o.destinoCoords.lat},${o.destinoCoords.lng})">Waze</button><button class="btn btn-primary btn-sm"onclick="openMaps(${o.destinoCoords.lat},${o.destinoCoords.lng})">Maps</button></div>`:''} ${o.clienteTelefono?`<button class="btn btn-whatsapp btn-sm"onclick="wa('${o.clienteTelefono}','${id}')"><i class="fab fa-whatsapp me-1"></i>Cliente</button>`:''}</div></div>`;});document.getElementById('dl').innerHTML=h}})};

window.updateSt=async(id,ns)=>{await fb.fs.updateDoc(fb.fs.doc(fb.db,'pedidos',id),{status:ns,updatedAt:fb.fs.serverTimestamp(),...(ns==='picked'?{pickedAt:fb.fs.serverTimestamp()}:{}), ...(ns==='delivered'?{deliveredAt:fb.fs.serverTimestamp()}:{})});Swal.fire({icon:'success',title:'Actualizado',timer:1500,showConfirmButton:false})};

window.sendOffer=async(pid,pi)=>{const{value:v}=await Swal.fire({title:'Contraoferta',html:`<p>Precio inicial: <strong>$${pi}</strong></p><input class="form-control mb-2"id="po"value="${(pi*.85).toFixed(2)}"type="number"><select class="form-select mb-2"id="pt"><option value="15 min">15 min</option><option value="30 min">30 min</option><option value="45 min">45 min</option></select><textarea class="form-control"id="pm"placeholder="Mensaje"></textarea>`,showCancelButton:true,preConfirm:()=>({p:parseFloat(document.getElementById('po').value),t:document.getElementById('pt').value,m:document.getElementById('pm').value})});if(v){Swal.fire({title:'Enviando...',allowOutsideClick:false,didOpen:()=>Swal.showLoading()});await fb.fs.addDoc(fb.fs.collection(fb.db,'contraofertas'),{pedidoId:pid,repartidorId:S.u.uid,repartidorNombre:S.d?.nombre,repartidorTelefono:S.d?.telefono,repartidorCalificacion:S.d?.calificacion||5,precioOfertado:v.p,tiempoEstimado:v.t,mensaje:v.m,estado:'pendiente',createdAt:fb.fs.serverTimestamp()});await fb.fs.updateDoc(fb.fs.doc(fb.db,'pedidos',pid),{estadoNegociacion:'contraoferta'});Swal.fire({icon:'success',title:'Enviada',timer:2000,showConfirmButton:false})}};

window.viewOffers=async pid=>{const q=fb.fs.query(fb.fs.collection(fb.db,'contraofertas'),fb.fs.where('pedidoId','==',pid),fb.fs.where('estado','==','pendiente'),fb.fs.orderBy('precioOfertado','asc')),s=await fb.fs.getDocs(q);if(s.empty)return Swal.fire('Sin ofertas','A√∫n no hay ofertas','info');let h='';s.forEach(d=>{const o=d.data();h+=`<div class="border rounded p-3 mb-2"style="background:#f8f9fa"><div class="d-flex justify-content-between mb-2"><strong>${o.repartidorNombre}</strong><span class="text-warning">‚≠ê${o.repartidorCalificacion||5}</span></div><h4 class="text-danger">$${o.precioOfertado}</h4><small>‚è±Ô∏è${o.tiempoEstimado}</small>${o.mensaje?`<p class="mt-2"><small>üí¨${o.mensaje}</small></p>`:''}<button class="btn btn-success btn-sm w-100"onclick="acceptOffer('${d.id}','${pid}')">Aceptar</button></div>`});Swal.fire({title:'Ofertas',html:h,width:600,showCloseButton:true})};

window.acceptOffer=async(cid,pid)=>{const{isConfirmed}=await Swal.fire({title:'¬øAceptar?',icon:'question',showCancelButton:true});if(!isConfirmed)return;Swal.fire({title:'Procesando...',allowOutsideClick:false,didOpen:()=>Swal.showLoading()});const cd=await fb.fs.getDoc(fb.fs.doc(fb.db,'contraofertas',cid));if(!cd.exists())return;const c=cd.data();await fb.fs.updateDoc(fb.fs.doc(fb.db,'contraofertas',cid),{estado:'aceptada'});await fb.fs.updateDoc(fb.fs.doc(fb.db,'pedidos',pid),{status:'accepted',repartidorId:c.repartidorId,repartidorNombre:c.repartidorNombre,repartidorTelefono:c.repartidorTelefono,precioFinal:c.precioOfertado,estadoNegociacion:'aceptada',acceptedAt:fb.fs.serverTimestamp()});Swal.fire({icon:'success',title:'Aceptada',html:`<p>$${c.precioOfertado}</p>`,timer:2000});myOrders()};

window.acceptDirect=async oid=>{const{isConfirmed}=await Swal.fire({title:'¬øAceptar?',text:'Al precio inicial',icon:'question',showCancelButton:true});if(!isConfirmed)return;const od=await fb.fs.getDoc(fb.fs.doc(fb.db,'pedidos',oid));if(!od.exists()||od.data().status!=='pending')return Swal.fire('Error','No disponible','error');const o=od.data();await fb.fs.updateDoc(fb.fs.doc(fb.db,'pedidos',oid),{status:'accepted',repartidorId:S.u.uid,repartidorNombre:S.d?.nombre,repartidorTelefono:S.d?.telefono,precioFinal:o.precioInicial||o.precio,estadoNegociacion:'aceptada',acceptedAt:fb.fs.serverTimestamp()});Swal.fire({icon:'success',title:'Aceptado',timer:2000,showConfirmButton:false});myDelivs()};

window.wa=(p,id)=>window.open(`https://wa.me/${p.replace(/\D/g,'')}?text=${encodeURIComponent(`Hola! Pedido #${id.substring(0,8)}`)}`,`_blank`);
window.openWaze=(lat,lng)=>window.open(`https://waze.com/ul?ll=${lat},${lng}&navigate=yes`,'_blank');
window.openMaps=(lat,lng)=>window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`,'_blank');
console.log('‚úÖ RapidSend FULL (Firebase 12.8.0)');
    </script>
</body>
</html>
