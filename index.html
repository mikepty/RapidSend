<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RapidSend - Entregas Express</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <style>
        :root {
            --primary: #e74c3c;
            --primary-dark: #c0392b;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f9f9f9 0%, #e8e8e8 100%);
        }
        .navbar-main {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%) !important;
            box-shadow: 0 2px 15px rgba(231, 76, 60, 0.3);
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border: none;
            font-weight: 700;
        }
        .card-main {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            border-top: 5px solid var(--primary);
        }
        #map, #orderMap, #mapaPedido {
            height: 400px;
            border-radius: 15px;
        }
        .whatsapp-btn {
            background: #25D366;
            color: white;
            border: none;
        }
        .order-card {
            background: white;
            border-left: 5px solid var(--primary);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .order-card.urgent {
            border-left-color: #e74c3c;
            background: linear-gradient(to right, rgba(231, 76, 60, 0.05), white);
        }
        .google-btn {
            background: white;
            border: 2px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        @media (max-width: 768px) {
            #map, #orderMap, #mapaPedido { height: 300px; }
        }
    </style>
</head>
<body>
    <div id="app">
        <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
            <div style="background: white; padding: 40px; border-radius: 20px; text-align: center;">
                <h1 style="color: #e74c3c;">RapidSend</h1>
                <div style="margin: 20px auto; width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #e74c3c; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <p>Cargando...</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    
    <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); }}</style>
    
    <script type="module">
        // FIREBASE 12.8.0
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, setDoc, updateDoc, query, where, orderBy, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDxD4g_uYEUKB37uNHvDWus_NQHoSAMK_8",
            authDomain: "rapidsend-1f640.firebaseapp.com",
            projectId: "rapidsend-1f640",
            storageBucket: "rapidsend-1f640.firebasestorage.app",
            messagingSenderId: "249514582496",
            appId: "1:249514582496:web:cafcc8760282983f24cb85"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        window.firebase = { 
            app, auth, db, googleProvider, 
            firestore: { collection, addDoc, getDocs, doc, getDoc, setDoc, updateDoc, query, where, orderBy, serverTimestamp, onSnapshot }, 
            authMethods: { createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, signInWithPopup }
        };
        
        window.AppState = { 
            currentUser: null, 
            userData: null, 
            userRole: null, 
            selectedOrigin: null, 
            selectedDestination: null 
        };

        onAuthStateChanged(auth, async (user) => {
            window.AppState.currentUser = user;
            if (user) {
                const userDoc = await getDoc(doc(db, 'usuarios', user.uid));
                if (userDoc.exists()) {
                    window.AppState.userData = userDoc.data();
                    window.AppState.userRole = userDoc.data().rol;
                } else {
                    await setDoc(doc(db, 'usuarios', user.uid), {
                        nombre: user.displayName || 'Usuario',
                        email: user.email,
                        rol: 'cliente',
                        telefono: '',
                        fechaRegistro: serverTimestamp(),
                        activo: false,
                        calificacion: 5.0,
                        entregasCompletadas: 0
                    });
                    window.AppState.userData = { nombre: user.displayName, email: user.email, rol: 'cliente' };
                    window.AppState.userRole = 'cliente';
                }
                renderMainLayout();
            } else {
                renderLoginScreen();
            }
        });

        window.renderLoginScreen = function() {
            document.getElementById('app').innerHTML = `
                <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); padding: 20px;">
                    <div style="background: white; padding: 40px; border-radius: 20px; max-width: 450px; width: 100%;">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h1 style="color: #e74c3c;">RapidSend</h1>
                            <p>Entregas Express</p>
                        </div>
                        <div class="mb-3">
                            <input type="email" class="form-control" id="loginEmail" placeholder="Correo electr√≥nico">
                        </div>
                        <div class="mb-3">
                            <input type="password" class="form-control" id="loginPassword" placeholder="Contrase√±a">
                        </div>
                        <button onclick="handleLogin()" class="btn btn-primary w-100 mb-3">Iniciar Sesi√≥n</button>
                        <button onclick="handleGoogleLogin()" class="google-btn btn w-100 mb-3">
                            <svg width="20" height="20" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
                            Google
                        </button>
                        <hr>
                        <div class="mb-3">
                            <input type="text" class="form-control" id="regName" placeholder="Nombre completo">
                        </div>
                        <div class="mb-3">
                            <input type="email" class="form-control" id="regEmail" placeholder="Correo">
                        </div>
                        <div class="mb-3">
                            <input type="password" class="form-control" id="regPassword" placeholder="Contrase√±a">
                        </div>
                        <div class="mb-3">
                            <input type="tel" class="form-control" id="regPhone" placeholder="WhatsApp +507">
                        </div>
                        <div class="mb-3">
                            <select class="form-select" id="regRole">
                                <option value="cliente">üë§ Cliente</option>
                                <option value="repartidor">üèçÔ∏è Repartidor</option>
                                <option value="institucion">üè• Instituci√≥n</option>
                            </select>
                        </div>
                        <button onclick="handleRegister()" class="btn btn-primary w-100">Registrarse</button>
                    </div>
                </div>
            `;
        };

        window.handleLogin = async function() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) return Swal.fire('Error', 'Completa todos los campos', 'error');
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                Swal.fire('Error', 'Credenciales incorrectas', 'error');
            }
        };

        window.handleRegister = async function() {
            const name = document.getElementById('regName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;
            const phone = document.getElementById('regPhone').value.trim();
            const role = document.getElementById('regRole').value;
            if (!name || !email || !password) return Swal.fire('Error', 'Completa todos los campos', 'error');
            try {
                const result = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(result.user, { displayName: name });
                await setDoc(doc(db, 'usuarios', result.user.uid), {
                    nombre: name,
                    email: email,
                    rol: role,
                    telefono: phone ? `+507${phone.replace(/\D/g, '')}` : '',
                    fechaRegistro: serverTimestamp(),
                    activo: false,
                    calificacion: 5.0,
                    entregasCompletadas: 0
                });
                Swal.fire('√âxito', 'Cuenta creada', 'success');
            } catch (error) {
                Swal.fire('Error', error.message, 'error');
            }
        };

        window.handleGoogleLogin = async function() {
            try {
                const result = await signInWithPopup(auth, googleProvider);
                const userDoc = await getDoc(doc(db, 'usuarios', result.user.uid));
                if (!userDoc.exists()) {
                    const { value: role } = await Swal.fire({
                        title: 'Selecciona tu rol',
                        input: 'select',
                        inputOptions: { 
                            'cliente': 'üë§ Cliente', 
                            'repartidor': 'üèçÔ∏è Repartidor',
                            'institucion': 'üè• Instituci√≥n'
                        },
                        showCancelButton: false
                    });
                    await setDoc(doc(db, 'usuarios', result.user.uid), {
                        nombre: result.user.displayName,
                        email: result.user.email,
                        rol: role,
                        telefono: '',
                        fechaRegistro: serverTimestamp(),
                        activo: false,
                        calificacion: 5.0,
                        entregasCompletadas: 0
                    });
                }
            } catch (error) {
                if (error.code !== 'auth/popup-closed-by-user') {
                    Swal.fire('Error', error.message, 'error');
                }
            }
        };

        window.renderMainLayout = function() {
            const role = window.AppState.userRole;
            const roleText = role === 'repartidor' ? 'Repartidor' : role === 'institucion' ? 'Instituci√≥n' : 'Cliente';
            
            document.getElementById('app').innerHTML = `
                <nav class="navbar navbar-main">
                    <div class="container-fluid">
                        <a class="navbar-brand text-white" href="#" onclick="loadHome()">
                            <i class="fas fa-bolt me-2"></i>RapidSend
                            <span class="badge bg-light text-dark ms-2">${roleText}</span>
                        </a>
                        <button class="btn btn-light" onclick="handleLogout()">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </nav>
                <div class="container py-4">
                    <div class="row">
                        <div class="col-md-3 mb-4">
                            <div class="card-main p-3">
                                <h5><i class="fas fa-bars me-2"></i>Men√∫</h5>
                                <div class="list-group">
                                    <button class="list-group-item list-group-item-action" onclick="loadHome()">
                                        <i class="fas fa-home me-2"></i>Inicio
                                    </button>
                                    ${role === 'cliente' || role === 'institucion' ? `
                                        <button class="list-group-item list-group-item-action" onclick="showCreateOrder()">
                                            <i class="fas fa-plus me-2"></i>Nuevo Pedido
                                        </button>
                                        <button class="list-group-item list-group-item-action" onclick="loadMyOrders()">
                                            <i class="fas fa-list me-2"></i>Mis Pedidos
                                        </button>
                                    ` : `
                                        <button class="list-group-item list-group-item-action" onclick="loadAvailableOrders()">
                                            <i class="fas fa-search me-2"></i>Pedidos Disponibles
                                        </button>
                                        <button class="list-group-item list-group-item-action" onclick="loadMyDeliveries()">
                                            <i class="fas fa-motorcycle me-2"></i>Mis Entregas
                                        </button>
                                        <button class="list-group-item list-group-item-action" onclick="toggleOnlineStatus()">
                                            <i class="fas fa-toggle-on me-2"></i>${window.AppState.userData?.activo ? 'Desconectar' : 'Conectar'}
                                        </button>
                                    `}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-9">
                            <div id="contentArea"></div>
                        </div>
                    </div>
                </div>
            `;
            loadHome();
        };

        window.loadHome = function() {
            const role = window.AppState.userRole;
            document.getElementById('contentArea').innerHTML = `
                <div class="card-main p-4">
                    <h2>Bienvenido, ${window.AppState.userData?.nombre}</h2>
                    <div class="row mt-4">
                        ${role === 'cliente' || role === 'institucion' ? `
                            <div class="col-md-4 mb-3">
                                <div class="card text-center p-4">
                                    <i class="fas fa-box fa-3x text-primary mb-3"></i>
                                    <h5>Crear Pedido</h5>
                                    <button class="btn btn-primary mt-2" onclick="showCreateOrder()">
                                        <i class="fas fa-plus me-2"></i>Nuevo
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card text-center p-4">
                                    <i class="fas fa-list fa-3x text-success mb-3"></i>
                                    <h5>Mis Pedidos</h5>
                                    <button class="btn btn-outline-primary mt-2" onclick="loadMyOrders()">Ver</button>
                                </div>
                            </div>
                        ` : `
                            <div class="col-md-4 mb-3">
                                <div class="card text-center p-4">
                                    <i class="fas fa-search fa-3x text-primary mb-3"></i>
                                    <h5>Buscar Pedidos</h5>
                                    <button class="btn btn-primary mt-2" onclick="loadAvailableOrders()">Buscar</button>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card text-center p-4">
                                    <i class="fas fa-motorcycle fa-3x text-success mb-3"></i>
                                    <h5>Mis Entregas</h5>
                                    <button class="btn btn-outline-primary mt-2" onclick="loadMyDeliveries()">Ver</button>
                                </div>
                            </div>
                        `}
                    </div>
                </div>
            `;
        };

        window.handleLogout = async function() {
            await signOut(auth);
        };

        console.log('‚úÖ RapidSend Firebase 12.8.0 Cargado');
    </script>
    <script>
        // ============================================
        // CREAR PEDIDO CON CAMPOS NUEVOS
        // ============================================
        window.showCreateOrder = async function() {
            window.AppState.selectedOrigin = null;
            window.AppState.selectedDestination = null;
            
            const { value: formValues } = await Swal.fire({
                title: 'üì¶ Nuevo Pedido',
                html: `
                    <div class="text-start">
                        <div class="mb-3">
                            <label class="form-label fw-bold">¬øQu√© vas a enviar?</label>
                            <input type="text" class="form-control" id="orderDesc" placeholder="Descripci√≥n del pedido">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Tipo de Pedido</label>
                            <select class="form-select" id="tipoPedido">
                                <option value="normal">üì¶ Normal</option>
                                <option value="medicamento">üíä Medicamento</option>
                                <option value="insumo_medico">üè• Insumo M√©dico</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Nivel de Urgencia</label>
                            <select class="form-select" id="nivelUrgencia">
                                <option value="baja">üü¢ Baja</option>
                                <option value="media" selected>üü° Media</option>
                                <option value="alta">üî¥ Alta</option>
                            </select>
                        </div>
                        
                        <div class="alert alert-info py-2 mb-2">
                            <small><i class="fas fa-info-circle me-1"></i> Click: 1¬∫ origen (rojo), 2¬∫ destino (verde)</small>
                        </div>
                        <div id="mapaPedido" style="height: 350px; border-radius: 10px; margin-bottom: 15px;"></div>
                        
                        <div class="row mb-3">
                            <div class="col-6">
                                <input type="text" class="form-control form-control-sm" id="orderFrom" placeholder="Origen" readonly>
                            </div>
                            <div class="col-6">
                                <input type="text" class="form-control form-control-sm" id="orderTo" placeholder="Destino" readonly>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="form-label">Precio inicial ($)</label>
                                <input type="number" class="form-control" id="orderPrice" value="10" min="5">
                            </div>
                            <div class="col-6">
                                <label class="form-label">Tiempo</label>
                                <select class="form-select" id="orderUrgency">
                                    <option value="standard">Normal (2-3h)</option>
                                    <option value="express">Express (1h)</option>
                                    <option value="urgent">Urgente (30min)</option>
                                </select>
                            </div>
                        </div>
                        
                        <textarea class="form-control" id="orderInstructions" rows="2" placeholder="Instrucciones (opcional)"></textarea>
                    </div>
                `,
                width: '90%',
                showCancelButton: true,
                confirmButtonText: 'Crear Pedido',
                didOpen: () => {
                    const map = L.map('mapaPedido').setView([8.9833, -79.5167], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                    
                    let clickCount = 0;
                    let originMarker = null;
                    let destMarker = null;
                    let routeControl = null;
                    
                    map.on('click', function(e) {
                        const coords = [e.latlng.lat, e.latlng.lng];
                        
                        if (clickCount === 0) {
                            if (originMarker) map.removeLayer(originMarker);
                            originMarker = L.marker(coords, {
                                icon: L.divIcon({
                                    html: '<div style="background: #e74c3c; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white;"></div>',
                                    iconSize: [30, 30],
                                    iconAnchor: [15, 30]
                                })
                            }).addTo(map);
                            
                            const addr = `${coords[0].toFixed(4)}, ${coords[1].toFixed(4)}`;
                            document.getElementById('orderFrom').value = addr;
                            window.AppState.selectedOrigin = { coords, address: addr };
                            clickCount = 1;
                        } else if (clickCount === 1) {
                            if (destMarker) map.removeLayer(destMarker);
                            destMarker = L.marker(coords, {
                                icon: L.divIcon({
                                    html: '<div style="background: #2ecc71; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white;"></div>',
                                    iconSize: [30, 30],
                                    iconAnchor: [15, 30]
                                })
                            }).addTo(map);
                            
                            const addr = `${coords[0].toFixed(4)}, ${coords[1].toFixed(4)}`;
                            document.getElementById('orderTo').value = addr;
                            window.AppState.selectedDestination = { coords, address: addr };
                            
                            if (routeControl) map.removeControl(routeControl);
                            routeControl = L.Routing.control({
                                waypoints: [L.latLng(window.AppState.selectedOrigin.coords), L.latLng(coords)],
                                lineOptions: { styles: [{ color: '#3498db', weight: 4 }] },
                                createMarker: () => null
                            }).addTo(map);
                            
                            const R = 6371;
                            const dLat = (coords[0] - window.AppState.selectedOrigin.coords[0]) * Math.PI / 180;
                            const dLon = (coords[1] - window.AppState.selectedOrigin.coords[1]) * Math.PI / 180;
                            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(window.AppState.selectedOrigin.coords[0] * Math.PI / 180) * Math.cos(coords[0] * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
                            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                            const distance = R * c;
                            const price = Math.max(5, Math.round(distance * 2));
                            document.getElementById('orderPrice').value = price;
                            clickCount = 2;
                        }
                    });
                    
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition((pos) => {
                            map.setView([pos.coords.latitude, pos.coords.longitude], 15);
                        });
                    }
                },
                preConfirm: () => {
                    const desc = document.getElementById('orderDesc').value.trim();
                    if (!desc || !window.AppState.selectedOrigin || !window.AppState.selectedDestination) {
                        Swal.showValidationMessage('Completa descripci√≥n y selecciona origen/destino');
                        return false;
                    }
                    return {
                        desc,
                        from: window.AppState.selectedOrigin.address,
                        to: window.AppState.selectedDestination.address,
                        originCoords: window.AppState.selectedOrigin.coords,
                        destCoords: window.AppState.selectedDestination.coords,
                        price: document.getElementById('orderPrice').value,
                        urgency: document.getElementById('orderUrgency').value,
                        instructions: document.getElementById('orderInstructions').value.trim(),
                        tipoPedido: document.getElementById('tipoPedido').value,
                        nivelUrgencia: document.getElementById('nivelUrgencia').value
                    };
                }
            });

            if (formValues) {
                try {
                    Swal.fire({ title: 'Creando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                    
                    await window.firebase.firestore.addDoc(
                        window.firebase.firestore.collection(window.firebase.db, 'pedidos'),
                        {
                            clienteId: AppState.currentUser.uid,
                            clienteNombre: AppState.userData?.nombre,
                            clienteTelefono: AppState.userData?.telefono || '',
                            clienteEmail: AppState.userData?.email,
                            descripcion: formValues.desc,
                            origen: formValues.from,
                            destino: formValues.to,
                            origenCoords: { lat: formValues.originCoords[0], lng: formValues.originCoords[1] },
                            destinoCoords: { lat: formValues.destCoords[0], lng: formValues.destCoords[1] },
                            urgencia: formValues.urgency,
                            precio: parseFloat(formValues.price),
                            instrucciones: formValues.instructions,
                            metodoPago: 'efectivo',
                            status: 'pending',
                            
                            // CAMPOS NUEVOS - Sistema de contraofertas
                            tipoPedido: formValues.tipoPedido,
                            nivelUrgencia: formValues.nivelUrgencia,
                            precioInicial: parseFloat(formValues.price),
                            precioFinal: null,
                            estadoNegociacion: 'abierta',
                            creadoPorRol: AppState.userRole,
                            institucionId: AppState.userRole === 'institucion' ? AppState.currentUser.uid : null,
                            
                            repartidorId: null,
                            repartidorNombre: null,
                            repartidorTelefono: null,
                            createdAt: window.firebase.firestore.serverTimestamp(),
                            updatedAt: window.firebase.firestore.serverTimestamp(),
                            acceptedAt: null,
                            pickedAt: null,
                            deliveredAt: null
                        }
                    );
                    
                    Swal.fire({ icon: 'success', title: 'Pedido creado', timer: 2000, showConfirmButton: false });
                    loadMyOrders();
                } catch (error) {
                    Swal.fire('Error', error.message, 'error');
                }
            }
        };

        // ============================================
        // MIS PEDIDOS (CLIENTE/INSTITUCI√ìN)
        // ============================================
        window.loadMyOrders = async function() {
            document.getElementById('contentArea').innerHTML = `
                <div class="card-main p-4">
                    <div class="d-flex justify-content-between mb-4">
                        <h2><i class="fas fa-list me-2"></i>Mis Pedidos</h2>
                        <button class="btn btn-primary" onclick="showCreateOrder()">
                            <i class="fas fa-plus me-2"></i>Nuevo
                        </button>
                    </div>
                    <div id="ordersList">Cargando...</div>
                </div>
            `;
            
            try {
                const q = window.firebase.firestore.query(
                    window.firebase.firestore.collection(window.firebase.db, 'pedidos'),
                    window.firebase.firestore.where('clienteId', '==', AppState.currentUser.uid),
                    window.firebase.firestore.orderBy('createdAt', 'desc')
                );
                
                window.firebase.firestore.onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        document.getElementById('ordersList').innerHTML = `
                            <div class="text-center py-5">
                                <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                                <h4>No hay pedidos</h4>
                                <button class="btn btn-primary" onclick="showCreateOrder()">Crear Pedido</button>
                            </div>
                        `;
                    } else {
                        let html = '<div class="row">';
                        snapshot.forEach(doc => {
                            const order = doc.data();
                            const id = doc.id;
                            const statusColor = order.status === 'pending' ? 'warning' : order.status === 'delivered' ? 'success' : 'info';
                            const statusText = order.status === 'pending' ? 'Pendiente' : order.status === 'delivered' ? 'Entregado' : 'En proceso';
                            const precioMostrar = order.precioFinal || order.precioInicial || order.precio;
                            
                            html += `
                                <div class="col-md-6 mb-3">
                                    <div class="order-card ${order.nivelUrgencia === 'alta' ? 'urgent' : ''}">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div>
                                                <h6>${order.descripcion}</h6>
                                                <small class="text-muted">#${id.substring(0, 8)}</small>
                                            </div>
                                            <span class="badge bg-${statusColor}">${statusText}</span>
                                        </div>
                                        <div class="mt-2">
                                            <small><i class="fas fa-map-marker-alt text-danger me-1"></i> ${order.origen.substring(0, 30)}...</small><br>
                                            <small><i class="fas fa-flag-checkered text-success me-1"></i> ${order.destino.substring(0, 30)}...</small>
                                        </div>
                                        <div class="mt-2">
                                            ${order.tipoPedido !== 'normal' ? `<span class="badge bg-info">${order.tipoPedido === 'medicamento' ? 'üíä Medicamento' : 'üè• Insumo M√©dico'}</span> ` : ''}
                                            ${order.nivelUrgencia ? `<span class="badge bg-${order.nivelUrgencia === 'alta' ? 'danger' : order.nivelUrgencia === 'media' ? 'warning' : 'secondary'}">${order.nivelUrgencia}</span>` : ''}
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mt-3">
                                            <strong class="text-primary">$${precioMostrar}</strong>
                                            ${order.status === 'pending' && order.estadoNegociacion === 'contraoferta' ? `
                                                <button class="btn btn-sm btn-warning" onclick="verContraofertas('${id}')">
                                                    <i class="fas fa-dollar-sign me-1"></i> Ver Ofertas
                                                </button>
                                            ` : ''}
                                        </div>
                                        ${order.repartidorTelefono && order.status !== 'delivered' ? `
                                            <button class="btn btn-sm whatsapp-btn w-100 mt-2" onclick="openWhatsApp('${order.repartidorTelefono}', '${id}')">
                                                <i class="fab fa-whatsapp me-1"></i> Contactar Repartidor
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                        document.getElementById('ordersList').innerHTML = html;
                    }
                });
            } catch (error) {
                document.getElementById('ordersList').innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
            }
        };

        // ============================================
        // PEDIDOS DISPONIBLES (REPARTIDOR)
        // ============================================
        window.loadAvailableOrders = async function() {
            document.getElementById('contentArea').innerHTML = `
                <div class="card-main p-4">
                    <h2><i class="fas fa-search me-2"></i>Pedidos Disponibles</h2>
                    <div id="availableList" class="mt-4">Cargando...</div>
                </div>
            `;
            
            const q = window.firebase.firestore.query(
                window.firebase.firestore.collection(window.firebase.db, 'pedidos'),
                window.firebase.firestore.where('status', '==', 'pending')
            );
            
            window.firebase.firestore.onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    document.getElementById('availableList').innerHTML = '<p class="text-muted text-center">No hay pedidos disponibles</p>';
                } else {
                    let html = '<div class="row">';
                    snapshot.forEach(doc => {
                        const order = doc.data();
                        const id = doc.id;
                        const precioInicial = order.precioInicial || order.precio;
                        
                        html += `
                            <div class="col-md-6 mb-3">
                                <div class="order-card ${order.nivelUrgencia === 'alta' ? 'urgent' : ''}">
                                    <div class="d-flex justify-content-between mb-2">
                                        <div>
                                            <h6>${order.descripcion}</h6>
                                            <small>Cliente: ${order.clienteNombre}</small>
                                        </div>
                                        ${order.tipoPedido !== 'normal' ? `<span class="badge bg-info">${order.tipoPedido === 'medicamento' ? 'üíä' : 'üè•'}</span>` : ''}
                                    </div>
                                    <div class="mt-2">
                                        <small><i class="fas fa-map-marker-alt text-danger me-1"></i> ${order.origen.substring(0, 25)}...</small><br>
                                        <small><i class="fas fa-flag-checkered text-success me-1"></i> ${order.destino.substring(0, 25)}...</small>
                                    </div>
                                    <div class="mt-2">
                                        ${order.nivelUrgencia ? `<span class="badge bg-${order.nivelUrgencia === 'alta' ? 'danger' : order.nivelUrgencia === 'media' ? 'warning' : 'secondary'}">${order.nivelUrgencia}</span>` : ''}
                                    </div>
                                    <div class="mt-3">
                                        <h5 class="text-primary mb-2">$${precioInicial}</h5>
                                        <div class="btn-group w-100">
                                            <button class="btn btn-success btn-sm" onclick="acceptOrderDirect('${id}')">
                                                <i class="fas fa-check me-1"></i> Aceptar
                                            </button>
                                            <button class="btn btn-warning btn-sm" onclick="enviarContraoferta('${id}', ${precioInicial})">
                                                <i class="fas fa-dollar-sign me-1"></i> Ofertar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    document.getElementById('availableList').innerHTML = html;
                }
            });
        };

        // ============================================
        // MIS ENTREGAS (REPARTIDOR)
        // ============================================
        window.loadMyDeliveries = async function() {
            document.getElementById('contentArea').innerHTML = `
                <div class="card-main p-4">
                    <h2><i class="fas fa-motorcycle me-2"></i>Mis Entregas</h2>
                    <div id="deliveriesList" class="mt-4">Cargando...</div>
                </div>
            `;
            
            const q = window.firebase.firestore.query(
                window.firebase.firestore.collection(window.firebase.db, 'pedidos'),
                window.firebase.firestore.where('repartidorId', '==', AppState.currentUser.uid)
            );
            
            window.firebase.firestore.onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    document.getElementById('deliveriesList').innerHTML = '<p class="text-muted text-center">No tienes entregas</p>';
                } else {
                    let html = '<div class="row">';
                    snapshot.forEach(doc => {
                        const order = doc.data();
                        const id = doc.id;
                        const statusColor = order.status === 'accepted' ? 'info' : order.status === 'picked' ? 'primary' : 'success';
                        const precioFinal = order.precioFinal || order.precioInicial || order.precio;
                        
                        html += `
                            <div class="col-md-6 mb-3">
                                <div class="order-card">
                                    <div class="d-flex justify-content-between mb-2">
                                        <div>
                                            <h6>${order.descripcion}</h6>
                                            <small>Cliente: ${order.clienteNombre}</small>
                                        </div>
                                        <span class="badge bg-${statusColor}">${order.status}</span>
                                    </div>
                                    <div class="mt-2">
                                        <small><i class="fas fa-map-marker-alt text-danger me-1"></i> ${order.origen.substring(0, 25)}...</small><br>
                                        <small><i class="fas fa-flag-checkered text-success me-1"></i> ${order.destino.substring(0, 25)}...</small>
                                    </div>
                                    <div class="mt-3">
                                        <h5 class="text-primary">$${precioFinal}</h5>
                                        <div class="btn-group-vertical w-100 gap-2">
                                            ${order.status === 'accepted' ? `
                                                <button class="btn btn-primary btn-sm" onclick="updateStatus('${id}', 'picked')">
                                                    <i class="fas fa-box me-1"></i> Recogido
                                                </button>
                                            ` : ''}
                                            ${order.status === 'picked' ? `
                                                <button class="btn btn-success btn-sm" onclick="updateStatus('${id}', 'delivered')">
                                                    <i class="fas fa-check me-1"></i> Entregado
                                                </button>
                                            ` : ''}
                                            ${order.destinoCoords ? `
                                                <div class="btn-group">
                                                    <button class="btn btn-info btn-sm" onclick="openInWaze(${order.destinoCoords.lat}, ${order.destinoCoords.lng})">
                                                        <i class="fab fa-waze"></i> Waze
                                                    </button>
                                                    <button class="btn btn-primary btn-sm" onclick="openInGoogleMaps(${order.destinoCoords.lat}, ${order.destinoCoords.lng})">
                                                        <i class="fas fa-map"></i> Maps
                                                    </button>
                                                </div>
                                            ` : ''}
                                            ${order.clienteTelefono ? `
                                                <button class="btn whatsapp-btn btn-sm" onclick="openWhatsApp('${order.clienteTelefono}', '${id}')">
                                                    <i class="fab fa-whatsapp me-1"></i> Contactar Cliente
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    document.getElementById('deliveriesList').innerHTML = html;
                }
            });
        };

        window.updateStatus = async function(orderId, newStatus) {
            try {
                await window.firebase.firestore.updateDoc(
                    window.firebase.firestore.doc(window.firebase.db, 'pedidos', orderId),
                    {
                        status: newStatus,
                        updatedAt: window.firebase.firestore.serverTimestamp(),
                        ...(newStatus === 'picked' ? { pickedAt: window.firebase.firestore.serverTimestamp() } : {}),
                        ...(newStatus === 'delivered' ? { deliveredAt: window.firebase.firestore.serverTimestamp() } : {})
                    }
                );
                Swal.fire({ icon: 'success', title: 'Actualizado', timer: 1500, showConfirmButton: false });
            } catch (error) {
                Swal.fire('Error', error.message, 'error');
            }
        };

        window.toggleOnlineStatus = async function() {
            const newStatus = !AppState.userData?.activo;
            try {
                await window.firebase.firestore.updateDoc(
                    window.firebase.firestore.doc(window.firebase.db, 'usuarios', AppState.currentUser.uid),
                    { activo: newStatus }
                );
                AppState.userData.activo = newStatus;
                Swal.fire({ icon: 'success', title: newStatus ? 'En l√≠nea' : 'Desconectado', timer: 1500, showConfirmButton: false });
                renderMainLayout();
            } catch (error) {
                Swal.fire('Error', error.message, 'error');
            }
        };

        window.openWhatsApp = function(phone, orderId) {
            const text = encodeURIComponent(`Hola! Pedido #${orderId.substring(0, 8)}`);
            window.open(`https://wa.me/${phone.replace(/\D/g, '')}?text=${text}`, '_blank');
        };

        window.openInWaze = function(lat, lng) {
            window.open(`https://waze.com/ul?ll=${lat},${lng}&navigate=yes`, '_blank');
        };

        window.openInGoogleMaps = function(lat, lng) {
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`, '_blank');
        };

        // ============================================
        // SISTEMA DE CONTRAOFERTAS
        // ============================================
        
        // REPARTIDOR: Enviar contraoferta
        window.enviarContraoferta = async function(pedidoId, precioInicial) {
            try {
                const { value: formValues } = await Swal.fire({
                    title: 'üí∞ Enviar Contraoferta',
                    html: `
                        <div class="text-start">
                            <p class="text-muted mb-3">Precio inicial: <strong>$${precioInicial}</strong></p>
                            <div class="mb-3">
                                <label class="form-label">Tu oferta ($)</label>
                                <input type="number" class="form-control" id="precioOferta" value="${(precioInicial * 0.85).toFixed(2)}" min="1" step="0.5">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tiempo estimado</label>
                                <select class="form-select" id="tiempoEstimado">
                                    <option value="15 min">15 minutos</option>
                                    <option value="30 min" selected>30 minutos</option>
                                    <option value="45 min">45 minutos</option>
                                    <option value="1 hora">1 hora</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Mensaje (opcional)</label>
                                <textarea class="form-control" id="mensajeOferta" rows="2" placeholder="Puedo recogerlo r√°pido"></textarea>
                            </div>
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Enviar Oferta',
                    preConfirm: () => {
                        const precio = parseFloat(document.getElementById('precioOferta').value);
                        if (!precio || precio <= 0) {
                            Swal.showValidationMessage('Precio inv√°lido');
                            return false;
                        }
                        return {
                            precioOfertado: precio,
                            tiempoEstimado: document.getElementById('tiempoEstimado').value,
                            mensaje: document.getElementById('mensajeOferta').value.trim()
                        };
                    }
                });
                
                if (!formValues) return;
                
                Swal.fire({ title: 'Enviando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                
                const pedidoDoc = await window.firebase.firestore.getDoc(
                    window.firebase.firestore.doc(window.firebase.db, 'pedidos', pedidoId)
                );
                
                if (!pedidoDoc.exists() || pedidoDoc.data().status !== 'pending') {
                    Swal.fire('Error', 'Pedido no disponible', 'error');
                    return;
                }
                
                await window.firebase.firestore.addDoc(
                    window.firebase.firestore.collection(window.firebase.db, 'contraofertas'),
                    {
                        pedidoId: pedidoId,
                        repartidorId: AppState.currentUser.uid,
                        repartidorNombre: AppState.userData?.nombre,
                        repartidorTelefono: AppState.userData?.telefono,
                        repartidorCalificacion: AppState.userData?.calificacion || 5.0,
                        precioOfertado: formValues.precioOfertado,
                        tiempoEstimado: formValues.tiempoEstimado,
                        mensaje: formValues.mensaje,
                        estado: 'pendiente',
                        createdAt: window.firebase.firestore.serverTimestamp()
                    }
                );
                
                await window.firebase.firestore.updateDoc(
                    window.firebase.firestore.doc(window.firebase.db, 'pedidos', pedidoId),
                    { estadoNegociacion: 'contraoferta', updatedAt: window.firebase.firestore.serverTimestamp() }
                );
                
                Swal.fire({ icon: 'success', title: 'Oferta enviada', timer: 2000, showConfirmButton: false });
                
            } catch (error) {
                Swal.fire('Error', error.message, 'error');
            }
        };

        // CLIENTE: Ver contraofertas
        window.verContraofertas = async function(pedidoId) {
            try {
                const q = window.firebase.firestore.query(
                    window.firebase.firestore.collection(window.firebase.db, 'contraofertas'),
                    window.firebase.firestore.where('pedidoId', '==', pedidoId),
                    window.firebase.firestore.where('estado', '==', 'pendiente'),
                    window.firebase.firestore.orderBy('precioOfertado', 'asc')
                );
                
                const snapshot = await window.firebase.firestore.getDocs(q);
                
                if (snapshot.empty) {
                    Swal.fire('Sin ofertas', 'A√∫n no hay contraofertas', 'info');
                    return;
                }
                
                let html = '<div class="text-start">';
                snapshot.forEach((doc) => {
                    const o = doc.data();
                    html += `
                        <div class="border rounded p-3 mb-2" style="background: #f8f9fa;">
                            <div class="d-flex justify-content-between mb-2">
                                <strong>${o.repartidorNombre}</strong>
                                <span class="text-warning">‚≠ê ${o.repartidorCalificacion?.toFixed(1) || '5.0'}</span>
                            </div>
                            <h4 class="text-primary mb-1">$${o.precioOfertado.toFixed(2)}</h4>
                            <small class="text-muted">‚è±Ô∏è ${o.tiempoEstimado}</small>
                            ${o.mensaje ? `<p class="mt-2 mb-2"><small>üí¨ ${o.mensaje}</small></p>` : ''}
                            <button class="btn btn-success btn-sm w-100" onclick="aceptarContraoferta('${doc.id}','${pedidoId}')">
                                <i class="fas fa-check me-1"></i> Aceptar
                            </button>
                        </div>
                    `;
                });
                html += '</div>';
                
                Swal.fire({ title: 'üí∞ Ofertas Recibidas', html: html, width: 600, showConfirmButton: false, showCloseButton: true });
                
            } catch (error) {
                Swal.fire('Error', error.message, 'error');
            }
        };

        // CLIENTE: Aceptar contraoferta
        window.aceptarContraoferta = async function(contraofertaId, pedidoId) {
            try {
                const result = await Swal.fire({
                    title: '¬øAceptar oferta?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'S√≠'
                });
                
                if (!result.isConfirmed) return;
                
                Swal.fire({ title: 'Procesando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                
                const contraDoc = await window.firebase.firestore.getDoc(
                    window.firebase.firestore.doc(window.firebase.db, 'contraofertas', contraofertaId)
                );
                
                if (!contraDoc.exists()) {
                    Swal.fire('Error', 'Oferta no encontrada', 'error');
                    return;
                }
                
                const contra = contraDoc.data();
                
                await window.firebase.firestore.updateDoc(
                    window.firebase.firestore.doc(window.firebase.db, 'contraofertas', contraofertaId),
                    { estado: 'aceptada', aceptadaAt: window.firebase.firestore.serverTimestamp() }
                );
                
                await window.firebase.firestore.updateDoc(
                    window.firebase.firestore.doc(window.firebase.db, 'pedidos', pedidoId),
                    {
                        status: 'accepted',
                        repartidorId: contra.repartidorId,
                        repartidorNombre: contra.repartidorNombre,
                        repartidorTelefono: contra.repartidorTelefono,
                        precioFinal: contra.precioOfertado,
                        estadoNegociacion: 'aceptada',
                        acceptedAt: window.firebase.firestore.serverTimestamp(),
                        updatedAt: window.firebase.firestore.serverTimestamp()
                    }
                );
                
                const otras = await window.firebase.firestore.getDocs(
                    window.firebase.firestore.query(
                        window.firebase.firestore.collection(window.firebase.db, 'contraofertas'),
                        window.firebase.firestore.where('pedidoId', '==', pedidoId),
                        window.firebase.firestore.where('estado', '==', 'pendiente')
                    )
                );
                
                otras.forEach(async (doc) => {
                    if (doc.id !== contraofertaId) {
                        await window.firebase.firestore.updateDoc(doc.ref, { estado: 'rechazada' });
                    }
                });
                
                Swal.fire({ icon: 'success', title: 'Oferta aceptada', html: `<p>Precio: $${contra.precioOfertado}</p>`, timer: 2000 });
                loadMyOrders();
                
            } catch (error) {
                Swal.fire('Error', error.message, 'error');
            }
        };

        // REPARTIDOR: Aceptar directo (sin contraoferta)
        window.acceptOrderDirect = async function(orderId) {
            try {
                const result = await Swal.fire({
                    title: '¬øAceptar pedido?',
                    text: 'Al precio inicial',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'S√≠'
                });
                
                if (!result.isConfirmed) return;
                
                Swal.fire({ title: 'Procesando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                
                const pedidoDoc = await window.firebase.firestore.getDoc(
                    window.firebase.firestore.doc(window.firebase.db, 'pedidos', orderId)
                );
                
                if (!pedidoDoc.exists() || pedidoDoc.data().status !== 'pending') {
                    Swal.fire('Error', 'Pedido no disponible', 'error');
                    return;
                }
                
                const pedido = pedidoDoc.data();
                
                await window.firebase.firestore.updateDoc(
                    window.firebase.firestore.doc(window.firebase.db, 'pedidos', orderId),
                    {
                        status: 'accepted',
                        repartidorId: AppState.currentUser.uid,
                        repartidorNombre: AppState.userData?.nombre,
                        repartidorTelefono: AppState.userData?.telefono,
                        precioFinal: pedido.precioInicial || pedido.precio,
                        estadoNegociacion: 'aceptada',
                        acceptedAt: window.firebase.firestore.serverTimestamp(),
                        updatedAt: window.firebase.firestore.serverTimestamp()
                    }
                );
                
                Swal.fire({ icon: 'success', title: 'Pedido aceptado', timer: 2000, showConfirmButton: false });
                loadMyDeliveries();
                
            } catch (error) {
                Swal.fire('Error', error.message, 'error');
            }
        };

        console.log('‚úÖ RapidSend con Sistema de Contraofertas Cargado (Firebase 12.8.0)');
    </script>
</body>
</html>
